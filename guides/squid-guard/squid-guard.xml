<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
          "/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY author 		SYSTEM	"author.xml">
<!ENTITY legal			SYSTEM  "legal.xml">
<!ENTITY squid.conf.patch	SYSTEM  "files/squid.conf.patch">
<!ENTITY squidGuard.conf.patch	SYSTEM  "files/squidGuard.conf.patch">
<!ENTITY squidguard-blacklist	SYSTEM  "files/squidguard-blacklist">
<!ENTITY update-squidguard	SYSTEM  "files/update-squidguard">
<!ENTITY squidGuard.cgi.patch	SYSTEM  "files/squidGuard.cgi.patch">

]>

<article xml:id='squid-guard' xml:lang='fr'>
<info>
  <title>Proxy Squid &amp; SquidGuard</title>
  &author;
  <abstract>
  <para>Avec l'évolution des usages de l'Internet, il devient nécessaire de
  garantir des conditions correctes de navigation et une protection minimale de
  la confidentialité des informations personnelles dans l'infrastructure
  système et réseau. Le service mandataire avec filtrage d'URLs est un outil
  indispensable dans la panoplie de sécurisation du trafic Web. On étudie dans
  ce document la configuration des outils libres Squid et SquidGuard.</para>
  </abstract>

  <keywordset>
    <keyword>squid</keyword>
    <keyword>cache</keyword>
    <keyword>proxy</keyword>
    <keyword>squidguard</keyword>
    <keyword>iptables</keyword>
  </keywordset>
</info>

<section xml:id="autodoc.legal.meta">
  &legal;
  <section xml:id='autodoc.meta'>
    <title>Méta-information</title>

    <para>Cet article est écrit avec 
    <link xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link> XML
    sur un système
    <link xlink:href="http://www.debian.org"><citetitle>Debian GNU/Linux</citetitle></link>.
    Il est disponible en version imprimable aux format PDF :
    <link xlink:href="http://www.inetoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
  </section>
</section>

<section xml:id='squid-guard.context'>
  <title>Le contexte</title>

  <para>Dans une infrastructure d'enseignement, le service Web mandataire ou
  <link
  xlink:href='http://en.wikipedia.org/wiki/Proxy_server'><wordasword>proxy</wordasword></link>
  vient logiquement s'insérer sur la passerelle à l'interface du réseau de
  campus. En effet, c'est à travers cette passerelle que transite tout le
  trafic utilisateur vers et depuis l'Internet.</para>

<mediaobject xml:id='squid-guard.context.archi0'>
  <imageobject>
    <imagedata fileref='images/squid-guard-archi0.png' format='PNG' contentwidth='14cm' width='15cm'/>
  </imageobject>
  <textobject>
    <phrase>Positionnement du service proxy dans l'architecture d'enseignement</phrase>
  </textobject>
  <caption>
    <para>Positionnement du service proxy dans l'architecture d'enseignement</para>
  </caption>
</mediaobject>

  <para>Le service mandataire doit s'intégrer dans l'environnement des services
  existants de routage, de filtrage et de traduction d'adresses
  <acronym>IP</acronym>. On peut schématiser le fonctionnement de ce service de
  la façon suivante :</para>

<mediaobject>
  <imageobject>
    <imagedata fileref='images/squid-guard-archi1.png' format='PNG' contentwidth='10cm' width='11cm'/>
  </imageobject>
  <textobject>
    <phrase>Positionnement du service proxy dans le système</phrase>
  </textobject>
  <caption>
    <para><link xlink:href='images/squid-guard-archi1.png'>Positionnement du service proxy
    dans le système</link></para>
  </caption>
</mediaobject>

  <para>Le mode de fonctionnement schématisé ici suppose que toutes les
  fonctions de routage, de filtrage, de traduction d'adresses, de
  <wordasword>proxying</wordasword> et de filtrage d'<acronym>URL</acronym>s
  soient implantées dans le même système physique. Compte tenu des contraintes
  usuelles d'exploitation, ce mode opératoire convient parfaitement.
  L'expérience à montré qu'un système moderne supporte très bien la charge. On
  verra plus loin les éléments de métrologie et de
  <wordasword>tuning</wordasword>.</para>

  <note>
    <title>Conventions typographiques</title>
    <para>Tous les exemples d'exécution des commandes sont précédés d'une
    invite utilisateur ou <wordasword>prompt</wordasword> spécifique au niveau
    des droits utilisateurs nécessaires sur le système.</para>
    <para>Toute commande précédée de l'invite <option>$</option> ne nécessite
    aucun privilège particulier et peut être utilisée au niveau utilisateur
    simple.</para>
    <para>Toute commande précédée de l'invite <option>#</option> nécessite les
    privilèges du super-utilisateur.</para>
  </note>
</section>

<section xml:id='squid-guard.install'>
  <title>L'installation des paquets Debian</title>

  <para>Pour la mise en place du service Web mandataire et du filtrage
  d'<acronym>URL</acronym>s, on s'appuie sur les paquets suivants de la branche
  <wordasword>testing</wordasword> de la distribution Debian GNU/Linux.</para>

  <itemizedlist>
    <listitem>
    <para><application>squid3</application> - A full featured Web Proxy cache (HTTP proxy)</para>
    <para>L'application de service Web mandataire proprement dite.</para>
    </listitem>
    <listitem>
    <para><application>squidclient</application> - A full featured Web Proxy cache (HTTP proxy) - control utility</para>
    <para>L'outil de contrôle et d'analyse du fonctionnement du service Web mandataire.</para>
    </listitem>
    <listitem>
    <para><application>squidguard</application> - filter, redirector and access controller plug for Squid</para>
    <para>L'outil de filtrage des <acronym>URL</acronym>s.</para>
    </listitem>
    <listitem>
    <para><application>iptables</application> - administration tools for packet filtering and NAT</para>
    <para>La partie utilisateur du système de filtrage réseau d'un système
    GNU/Linux nécessaire à l'interception du trafic Web.</para>
    </listitem>
  </itemizedlist>

  <para>On débute avec l'installation des trois paquets listés ci-dessus. En
  plus de l'installation des logiciels, une première configuration des services
  est mise en place. Cette configuration de base est à retravailler pour
  l'adapter au contexte d'exploitation.</para>

<screen width='80'># aptitude install squid3 squidclient squidguard
Lecture des listes de paquets... Fait
Construction de l'arbre des dépendances
Lecture des informations d'état... Fait
Lecture de l'information d'état étendu
Initialisation de l'état des paquets... Fait
Les NOUVEAUX paquets suivants vont être installés :
  squid3 squid3-common{a} squidclient squidguard
0 paquets mis à jour, 4 nouvellement installés, 0 à enlever et 0 non mis à jour.
Il est nécessaire de télécharger 1449ko d'archives. Après dépaquetage, 7881ko seront utilisés.
Voulez-vous continuer ? [Y/n/?]
Écriture de l'information d'état étendu... Fait
Prendre : 1 http://ftp.fr.debian.org testing/main squid3-common 3.0.STABLE8-1 [289kB]
Prendre : 2 http://ftp.fr.debian.org testing/main squid3 3.0.STABLE8-1 [936kB]
Prendre : 3 http://ftp.fr.debian.org testing/main squidclient 3.0.STABLE8-1 [87,4kB]
Prendre : 4 http://ftp.fr.debian.org testing/main squidguard 1.2.0-8.4 [136kB]
 1449ko téléchargés en 1s (1204ko/s)
Préconfiguration des paquets...
Sélection du paquet squid3-common précédemment désélectionné.
(Lecture de la base de données... 52990 fichiers et répertoires déjà installés.)
Dépaquetage de squid3-common (à partir de .../squid3-common_3.0.STABLE8-1_all.deb) ...
Sélection du paquet squid3 précédemment désélectionné.
Dépaquetage de squid3 (à partir de .../squid3_3.0.STABLE8-1_i386.deb) ...
Sélection du paquet squidclient précédemment désélectionné.
Dépaquetage de squidclient (à partir de .../squidclient_3.0.STABLE8-1_i386.deb) ...
Sélection du paquet squidguard précédemment désélectionné.
Dépaquetage de squidguard (à partir de .../squidguard_1.2.0-8.4_i386.deb) ...
Traitement des actions différées (« triggers ») pour « man-db »...
Paramétrage de squid3-common (3.0.STABLE8-1) ...
Paramétrage de squid3 (3.0.STABLE8-1) ...
Creating Squid HTTP proxy 3.0 spool directory structure
2008/10/30 18:44:57| Creating Swap Directories
2008/10/30 18:44:57| /var/spool/squid3 exists
2008/10/30 18:44:57| Making directories in /var/spool/squid3/00
2008/10/30 18:44:57| Making directories in /var/spool/squid3/01
2008/10/30 18:44:57| Making directories in /var/spool/squid3/02
2008/10/30 18:44:57| Making directories in /var/spool/squid3/03
2008/10/30 18:44:57| Making directories in /var/spool/squid3/04
2008/10/30 18:44:57| Making directories in /var/spool/squid3/05
2008/10/30 18:44:57| Making directories in /var/spool/squid3/06
2008/10/30 18:44:57| Making directories in /var/spool/squid3/07
2008/10/30 18:44:57| Making directories in /var/spool/squid3/08
2008/10/30 18:44:57| Making directories in /var/spool/squid3/09
2008/10/30 18:44:57| Making directories in /var/spool/squid3/0A
2008/10/30 18:44:57| Making directories in /var/spool/squid3/0B
2008/10/30 18:44:57| Making directories in /var/spool/squid3/0C
2008/10/30 18:44:57| Making directories in /var/spool/squid3/0D
2008/10/30 18:44:58| Making directories in /var/spool/squid3/0E
2008/10/30 18:44:58| Making directories in /var/spool/squid3/0F
Restarting Squid HTTP Proxy 3.0: squid3.
Paramétrage de squidclient (3.0.STABLE8-1) ...
Paramétrage de squidguard (1.2.0-8.4) ...
/usr/sbin/update-squidguard not run automatically
Check Debconf settings for squidguard to change
Lecture des listes de paquets... Fait
Construction de l'arbre des dépendances
Lecture des informations d'état... Fait
Lecture de l'information d'état étendu
Initialisation de l'état des paquets... Fait
Écriture de l'information d'état étendu... Fait
</screen>

  <para>Avant de s'attaquer à la configuration des services, on commence par
  modifier l'arborescence de l'outil de filtrage d'<acronym>URL</acronym>s
  <application>squidguard</application>. Par défaut, cet outil est prévu pour
  fonctionner avec la génération précédente du service mandataire
  <application>squid</application> : la version 2.xx</para>

<screen width='80'># mv /etc/squid/squidGuard.conf /etc/squid3/
# rm -rf /etc/squid
# ln -s /etc/squid3 /etc/squid
# ll /etc/ | grep squid
lrwxrwxrwx 1 root   root     11 nov  2 16:43 squid -> /etc/squid3
drwxr-xr-x 2 root   root   1,0K nov  2 16:42 squid3

# ll /etc/squid3/
total 162K
-rw-r--r-- 1 root root  421 jui 21 10:01 msntauth.conf
-rw-r--r-- 1 root root 158K jui 21 10:00 squid.conf
-rw-r--r-- 1 root root 1,3K jui 23 14:28 squidGuard.conf
</screen>

  <para>Avec les opérations ci-dessus, les fichiers de configurations sont tous
  placés dans le même répertoire et le lien symbolique permet de s'assurer
  qu'une mise à jour du paquet <application>squidguard</application> se déroule
  correctement.</para>
</section>

<section xml:id='squid-guard.squid'>
  <title>La configuration du service Web mandataire
  (<wordasword>proxy</wordasword>)</title>

  <para>Tous les paramètres de configuration du démon <systemitem >squid</systemitem> sont rassemblés dans le fichier
  <filename>squid.conf</filename>. Ce fichier est particulièrement volumineux
  et par conséquent difficile à prendre en main. Décrire toutes les
  fonctionnalités offertes par ces paramètres dépasse très largement le cadre
  de ce billet. On se contente donc de présenter un
  <wordasword>patch</wordasword> qui fait ressortir les paramètres modifiés
  pour les besoins du contexte d'exploitation.</para>

<screen width='80'>$ diff -uBb /etc/squid3/squid.conf squid.conf.new 
&squid.conf.patch;</screen>

  <para>Voici quelques éléments sur les paramètres introduits ou modifiés.</para>

  <variablelist>
    <varlistentry>
      <term>acl mynetworks src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16</term>
      <listitem>
      <para>Cette liste de contrôle d'accès introduite avec l'option
      <option>acl</option> désigne les adresses réseau utilisées dans
      l'infrastructure de travaux pratiques. Si on se réfère au <link
      xlink:href='http://www.inetdoc.net/travaux_pratiques/archi.tp/archi.tp.adressage.html'>Plan
      d'adressage</link> de cette infrastructure, on considère que le trafic
      Web est susceptible de provenir de toutes les classes d'adresses
      <acronym>IP</acronym> privées désignées dans le document standard <link
      xlink:href='http://www.faqs.org/rfcs/rfc1918.html'>RFC1918</link>.</para> 

      <para>L'option <option>src</option> indique que ce sont les adresses
      <acronym>IP</acronym> sources qui sont utilisées comme critère d'accès au
      service <wordasword>proxy</wordasword>.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>http_access allow mynetworks</term>
      <listitem>
      <para>La directive <option>http_access</option> contrôle l'accès au
      service via le protocole <acronym>HTTP</acronym>. Dans le cas présent, il
      s'agit d'ouvrir l'accès aux réseaux de l'infrastructure de travaux
      pratiques. La configuration par défaut, telle que fournie lors de
      l'installation du paquet, interdit tout accès au service. Cette règle
      restreint donc l'accès aux seules adresses <acronym>IP</acronym>
      utilisées pour les travaux pratiques.</para>  
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>icp_access allow mynetworks</term>
      <listitem>
      <para>La directive <option>icp_access</option> joue le même rôle que la
      précédente pour le protocole <acronym>ICP</acronym>. L'<link
      xlink:href='http://en.wikipedia.org/wiki/Internet_Cache_Protocol'>Internet Cache
      Protocol</link> est utilisé pour le dialogue entre services mandataires.
      Tout comme dans le cas précédent, on autorise le fonctionnement du
      protocole à partir des adresses <acronym>IP</acronym> de l'infrastructure
      de travaux pratiques.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>http_port 3128 transparent</term>
      <listitem>
      <para>La directive <option>http_port</option> désigne le numéro du port
      sur lequel le service mandataire est en écoute. Dans le cas de
      <application>squid</application>, le numéro usuel est le
      <option>3128</option>. Il n'est pas nécessaire de modifier ce numéro de
      port. L'option <option>transparent</option> est importante. Elle définit
      le mode d'utilisation du service : un cache transparent pour le
      trafic Web utilisateur.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>cache_mem 64 MB</term>
      <listitem>
      <para>Le paramètre <option>cache_mem</option> désigne la quantité idéale
      de mémoire allouée pour le stockage de différents types d'objets en
      «transit» dans le service. Cette quantité peut très bien être dépassée en
      fonction du taux de requêtes entrantes. Si ce taux est élevé, ce
      paramètre est utilisé pour calculer le seuil de remplacement des anciens
      objets dans la mémoire.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>maximum_object_size_in_memory 128 KB</term>
      <listitem>
      <para>Définition de la taille maximum d'un objet conservé en
      mémoire cache. Les objets de taille supérieure ne sont pas conservés en
      mémoire vive.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>memory_replacement_policy heap LFUDA</term>
      <listitem>
      <para>Définition de la politique utilisée pour remplacer les
      objets stockés dans le cache mémoire lorsqu'il est nécessaire de trouver
      de la place libre. L'option retenue ici est <wordasword>Least Frequently
      Used with Dynamic Aging</wordasword>. Elle correspond à un usage de type
      pile basé sur le taux d'utilisation d'un objet du cache combiné à son
      ancienneté.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>cache_replacement_policy heap LFUDA</term>
      <listitem>
      <para>Définition de la politique utilisée pour remplacer les
      objets stockés dans le cache disque lorsqu'il est nécessaire de trouver
      de la place libre. L'option retenue ici est identique à la
      précédente.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>cache_dir aufs /var/spool/squid3 16384 16 256</term>
      <listitem>
      <para>Définition du mode d'utilisation du cache disque du service
      mandataire. L'option <option>aufs</option> correspond au format de
      stockage des objets sur disque. Elle utilise les fonctions multi-tâches
      <link xlink:href='http://en.wikipedia.org/wiki/POSIX_Threads'><wordasword>POSIX
      Threads</wordasword></link>.</para>

      <para>Du point de vue occupation disque, on réserve 16Go distribués sur
      16 répertoires de premier niveau puis sur 256 répertoires de second
      niveau.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf</term>
      <listitem>
      <para>La directive <option>url_rewrite_program</option> désigne l'outil
      utilisé pour le filtrage des <acronym>URL</acronym>s :
      <application>squidGuard</application>.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>url_rewrite_children 20</term>
      <listitem>
      <para>Définition du nombre de processus enfants générés pour
      répondre aux requêtes transmises par le démon <systemitem
      class='daemon'>squid</systemitem>. La valeur donnée doit permettre
      d'optimiser les temps de réponses en lançant suffisamment d'instances
      <application>squidGuard</application> tout en utilisant raisonnablement
      les ressources du système.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>request_header_max_size 32 KB</term>
      <listitem>
      <para>Définition de la taille maximum d'un en-tête
      <acronym>HTTP</acronym> lors d'une requête.</para>
      <para>Le choix d'une taille de 32Ko doit permettre de laisser passer le
      trafic «normal» sans entraver les accès. À voir en fonction
      d'utilisations particulières du protocole <acronym>HTTP</acronym>.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>reply_header_max_size 32 KB</term>
      <listitem>
      <para>Définition de la taille maximum d'un en-tête de réponse
      <acronym>HTTP</acronym>. La valeur retenue est identique à celle du
      paramètre précédent.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>acl debian dstdomain .debian.org</term>
      <term>always_direct allow debian</term>
      <listitem>
      <para>Cette liste de contrôle d'accès concerne toutes les requêtes à
      destination du domaine <systemitem
      class='domainname'>.debian.org</systemitem> et de ses
      sous-domaines.</para>

      <para>La directive <option>always_direct</option> spécifie les requêtes
      qui doivent toujours être directement transmises au serveur
      d'origine.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>pipeline_prefetch on</term>
      <listitem>
      <para>Directive utilisée pour doper les performances et se rapprocher
      d'une navigation Web sans service mandataire.</para>
      </listitem>
    </varlistentry>
  </variablelist>

  <para>Bien sûr, tous ces paramètres peuvent être «retravaillés» pour répondre
  mieux à d'autres contextes d'exploitation. Seule l'expérience acquise en
  cours d'exploitation peut permettre de répondre précisément à un
  besoin.</para>
  
  <para>Les commentaires du fichier de configuration
  <filename>/etc/squid/squid.conf</filename> constituent le meilleur point
  d'entrée pour aborder la documentation du paquet
  <application>squid3</application>. Ensuite, le <link
  xlink:href='http://wiki.squid-cache.org/'>Wiki Squid</link> fournit des exemples de
  configurations très intéressants.</para>

  <para>Arrivé à cette étape, il ne reste plus qu'à appliquer le
  <wordasword>patch</wordasword> sur le fichier de configuration du service
  mandataire.</para>

<screen width='80'># cp /etc/squid/squid.conf /etc/squid/squid.conf.dpkg-dist
# patch -l -p0 /etc/squid/squid.conf squid.conf.patch
patching file /etc/squid/squid.conf

# ll /etc/squid/
total 336K
-rw-r--r-- 1 root root  421 jui 21 12:31 msntauth.conf
-rw-r--r-- 1 root root 158K nov  8 19:40 squid.conf
-rw-r--r-- 1 root root 158K nov  8 19:40 squid.conf.dpkg-dist
-rw-r--r-- 1 root root 1,3K jui 24 23:15 squidGuard.conf</screen>

  <para>À ce stade de la configuration, le service n'est pas encore
  opérationnel. Il faut maintenant configurer l'application de filtrage des
  <acronym>URL</acronym>s : <application>squidGuard</application>.</para>
</section>

<section xml:id='squid-guard.squidGuard'>
  <title>La configuration du service de filtrage des URLs</title>

  <para>Comme dans le cas du service mandataire, le fichier
  <filename>/etc/squid/squidGuard.conf</filename> est point de départ de la
  configuration de l'outil. À la différence de
  <application>squid</application>, cette configuration dépend essentiellement
  de «l'alimentation» en listes noires d'<acronym>URL</acronym>s ou de noms de
  domaines.</para>

  <para>Même si ce fichier est moins volumineux que celui de la section
  précédente, on reprend la technique du <wordasword>patch</wordasword> pour
  illustrer les différences entre le fichier distribué via le paquet et celui
  exploité dans le contexte courant.</para>

<screen width='80'>$ diff -uBb /etc/squid3/squidGuard.conf squidGuard.conf.new 
&squidGuard.conf.patch;</screen>

  <para>Bien entendu, la sélection des catégories retenues est totalement
  arbitraire et le <wordasword>patch</wordasword> de configuration proposé ne
  prétend pas répondre à tous les besoins. Voici quelques éléments sur la
  configuration de <application>squidguard</application> en reprenant les mêmes
  limitations que pour le service mandataire : la documentation de toutes
  les options de l'outil sort complètement du cadre de ce billet.</para>

  <variablelist>
    <varlistentry>
      <term>dbhome</term>
      <listitem>
      <para>Définition du répertoire de stockage de la base de données des
      listes noires. L'utilisation de ce répertoire est détaillée dans <xref
      linkend='squid-guard.blacklists'/>.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>logdir</term>
      <listitem>
      <para>Définition du répertoire de stockage du fichier de journalisation
      de l'outil. Généralement, on utilise le même répertoire que le service
      mandataire sachant que les processus des deux services sont exécutés sous
      la même identité. Ces processus ont donc les mêmes droits sur
      l'arborescence.</para>
      </listitem>
    </varlistentry>
  </variablelist>

  <para>Comme toutes les entrées de liste noire utilisent la même syntaxe, on
  ne s'intéresse qu'à un exemple : les listes noires
  <wordasword>warez</wordasword>.</para>

  <variablelist>
    <varlistentry>
      <term>dest warez</term>
      <listitem>
      <para>Définition d'une catégorie de trafic à bloquer. À l'intérieur de
      cette catégorie, on peut définir des listes de noms de domaines,
      d'<acronym>URL</acronym>s et d'expressions rationnelles.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>domainlist warez/domains</term>
      <listitem>
      <para>Fichier contenant la liste des noms de domaines de la catégorie à
      bloquer. Il s'agit d'un fichier texte avec un nom de domaine par
      ligne.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>expressionlist warez/expressions</term>
      <listitem>
      <para>Fichier texte de définition des expressions rationnelles de
      filtrage. Généralement, il s'agit de filtrer les accès aux contenus
      stockés dans les caches des outils de recherche célèbres.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>urllist warez/urls</term>
      <listitem>
      <para>Fichier texte contenant la liste des <acronym>URL</acronym>s
      accessibles à partir de noms de domaines «valides». Il s'agit
      généralement de sous-répertoires d'hébergement de fournisseurs d'accès
      Internet.</para>
      </listitem>
    </varlistentry>
  </variablelist>

  <para>Une catégorie <wordasword>white</wordasword> pour «liste blanche» a été
  ajoutée manuellement pour traiter les exceptions ; c'est-à-dire les
  domaines pour lesquels l'accès est toujours autorisé.</para>

  <para>La dernière section concerne l'application des règles de traitement des
  catégories définies plus haut.</para>

  <variablelist>
    <varlistentry>
      <term>acl</term>
      <listitem>
      <para>Section d'application des règles de traitement. Il est possible de
      définir plusieurs sections de ce type et de mettre en place une
      administration plus fine du service. Dans notre exemple, on ne définit
      qu'un seul mode de traitement global pour tous les utilisateurs situés
      dans le périmètre d'interception du service mandataire.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>default</term>
      <listitem>
      <para>Section de définition des traitements par défaut.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>pass</term>
      <listitem>
      <para>Tout le trafic vers les entrées enregistrées dans une catégorie
      précédée du caractère <keycap>!</keycap> est bloqué. À l'inverse, tout le
      trafic correspondant à une catégorie listée est autorisé.</para>

      <para>Dans l'exemple, on a utilisé plusieurs lignes débutant par
      l'instruction <option>pass</option> pour éviter d'avoir une ligne trop
      longue. Il faut considérer que les catégories sont examinées
      séquentiellement pour les lignes <option>pass</option> saisies.</para>

      <para>La dernière «catégorie» notée <option>all</option> correspond à
      toutes les autres destinations non filtrées.</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>redirect</term>
      <listitem>
      <para>Instruction de redirection vers une page Web donnée pour les
      destinations bloquées. Ici, la redirection a lieu vers le service Web
      interne à l'infrastructure de travaux pratiques. Voir <xref
      linkend='squid-guard.redirect'/>.</para>
      </listitem>
    </varlistentry>
  </variablelist>
</section>

<section xml:id='squid-guard.blacklists'>
  <title>La gestion des listes noires</title>

  <para>Le choix de la source de listes noires d'<acronym>URL</acronym>s
  (et|ou) de noms de domaines a un impact très important sur la configuration
  de l'outil de filtrage <application>squidGuard</application>. Pour les
  besoins d'exploitation d'une infrastructure d'enseignement, le service offert
  par <link
  xlink:href='http://cri.univ-tlse1.fr/documentations/cache/squidguard.html'>Centre de
  Ressources Informatiques de l'Université de Toulouse I</link> convient
  parfaitement !.</para>

  <para>La démarche suivie ici ne s'embarrasse pas du choix de tel ou tel
  service. On télécharge la totalité des listes en une opération unique et on
  utilise le script d'indexation fourni par le paquet
  <application>squidguard</application> pour construire la base de
  données en fonction de la configuration présentée dans <xref
  linkend='squid-guard.squidGuard'/>.</para>

  <para>L'adresse de la page de téléchargement des listes noires est :
  <link
  xlink:href='http://cri.univ-tlse1.fr/blacklists/'>http://cri.univ-tlse1.fr/blacklists/</link>.
  Voici un exemple de traitement manuel de ces listes.</para>

<screen width='80'><prompt>$</prompt> cd /var/tmp/
<prompt>$</prompt> wget http://dsi.ut-capitole.fr/blacklists/download/blacklists.tar.gz
--2015-09-05 21:02:12--  http://dsi.ut-capitole.fr/blacklists/download/blacklists.tar.gz
Résolution de dsi.ut-capitole.fr (dsi.ut-capitole.fr)… 193.49.48.249
Connexion à dsi.ut-capitole.fr (dsi.ut-capitole.fr)|193.49.48.249|:80… connecté.
requête HTTP transmise, en attente de la réponse… 200 OK
Taille : 9606794 (9,2M) [application/x-gzip]
Sauvegarde en : « blacklists.tar.gz »

blacklists.tar.gz  100%[=================>]   9,16M   346KB/s   ds 48s    

2015-09-05 21:03:00 (195 KB/s) — « blacklists.tar.gz » sauvegardé [9606794/9606794]

<prompt>$</prompt> tar xf blacklists.tar.gz</screen>

  <para>À l'issue de ce téléchargement et de la décompression du fichier
  d'archive, le répertoire <filename class='directory'>blacklist</filename>
  contient les répertoires qui correspondent aux différentes «catégories» de
  listes noires. Le choix entre les différentes catégories se fait dans le
  fichier de configuration du paquet
  <application>squidguard</application>.</para>

<screen width='80'># mv blacklists/* /var/lib/squidguard/db/

# update-squidguard
Double checking directory and file permissions...done!
Re-building SquidGuard db files...done!
Reloading Squid...done!</screen>

   <para>Une fois que l'on a validé le processus manuellement, il est
   préférable d'automatiser le traitement pour assurer une mise à jour
   périodique des enregistrements en liste noire. Voici un exemple de
   <wordasword>Shell script</wordasword> à déposer dans le répertoire <filename
   class='directory'>/etc/cron.weekly/</filename> pour qu'il soit exécuté 
   toutes les semaines.</para>

<screen width='80'>&squidguard-blacklist;</screen>

   <para>Ce script reprend simplement les étapes réalisées manuellement plus
   haut et fait appel au script <systemitem>update-squidguard</systemitem>
   fourni avec le paquet <application>squidguard</application>.</para>

   <para>Il faut juste noter que ce dernier script à été modifié pour relancer
   <systemitem>squid3</systemitem> en lieu et place de
   <application>squid</application>. Voici une copie dans laquelle les lignes
   13 et 15 ont été modifiées.</para>

<screen width='80'>&update-squidguard;</screen>
</section>

<section xml:id='squid-guard.redirect'>
  <title>La redirection de page Web pour le trafic bloqué</title>

  <para>Lorsqu'une requête <acronym>HTTP</acronym> correspond à une règle de
  blocage, elle est redirigé vers une page définie dans le fichier de
  configuration de <application>squidguard</application>. Le paquet fournit un
  exemple de script <link
  xlink:href='http://fr.wikipedia.org/wiki/Common_Gateway_Interface'><acronym>CGI</acronym></link>
  qui renvoie une page Web type à l'utilisateur.</para>

  <para>Voici les étapes nécessaires à la mise en œuvre de ce script.</para>
 
<screen width='80'># cd /usr/lib/cgi-bin/
# cp /usr/share/doc/squidguard/examples/squidGuard.cgi.gz .
# gzip -d squidGuard.cgi.gz
# iconv -f iso8859-1 -t utf8 /usr/lib/cgi-bin/squidGuard.cgi >squidGuard.cgi.tmp
# mv squidGuard.cgi.tmp /usr/lib/cgi-bin/squidGuard.cgi
# chmod +x squidGuard.cgi</screen>

  <para>Pour l'édition du script <acronym>CGI</acronym> qui est assez long, on
  reprend la technique du <wordasword>patch</wordasword> pour illustrer les
  différences entre la version délivrée avec le paquet et celle en
  exploitation.</para>

<screen width='80'>$ diff -uBb squidGuard.cgi /usr/lib/cgi-bin/squidGuard.cgi
&squidGuard.cgi.patch;</screen>

  <para>Les modifications sont exclusivement d'ordre cosmétique. Il s'agit
  juste d'afficher le logo <application>squidguard</application> correctement
  et de donner des paramètres de redirection corrects dans le contexte
  d'exploitation. De plus, pour faciliter l'affichage entre les différents
  types de navigateurs, on ajoute deux jeux de balises <option>meta</option>,
  dans l'en-tête <acronym>HTML</acronym> de la page Web.</para>

  <para>Voici le résultat d'une tentative de navigation sur un site de la
  catégorie <wordasword>warez</wordasword>.</para>

<mediaobject>
  <imageobject>
    <imagedata fileref='images/squid-guard-cgi.png' format='PNG' contentwidth='14cm' width='15cm'/>
  </imageobject>
  <textobject>
    <phrase>Résultat de la rédirection d'affichage</phrase>
  </textobject>
  <caption>
    <para><link xlink:href='images/squid-guard-cgi.png'>Résultat de la rédirection
    d'affichage</link></para>
  </caption>
</mediaobject>
</section>

<section xml:id='squid-guard.intercept'>
  <title>L'interception du trafic Web</title>

  <para>Il existe plusieurs techniques pour intercepter le trafic Web sortant
  d'un périmètre en fonction des équipements utilisés. Ces techniques sont
  résumées dans le document <link
  xlink:href='http://tldp.org/HOWTO/TransparentProxy.html'><citetitle>Transparent
  Proxy with Linux and Squid mini-HOWTO</citetitle></link>. Si ce document
  date un peu, les principes restent les mêmes. Dans l'<link
  linkend='squid-guard.context.archi0'>architecture présentée plus
  haut</link>, le service mandataire est exécuté directement sur la passerelle
  de routage. L'interception du trafic Web vers le service mandataire doit donc
  se faire sur le même système.</para>

  <para>En utilisant le système de filtrage réseau netfilter/iptables sur un
  système GNU/Linux, la règle de base de l'interception est la
  suivante :</para>

<screen width='80'># iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j REDIRECT --to-port 3128
</screen>

  <para>Avec cette règle de la table de traduction d'adresses
  (<acronym>NAT</acronym>), tout paquet entrant par l'interface
  <option>eth1</option> utilisant le protocole <acronym>TCP</acronym> avec le
  port destination <option>80</option> est redirigé vers le processus local en
  écoute sur le port <option>3128</option>. Dans ce contexte, le processus
  local correspond au numéro de port défini dans la configuration du service
  Web mandataire : <application>squid</application>. Il faut aussi
  préciser que l'interface <option>eth1</option> doit être située du côté
  interne de la passerelle d'interface avec le réseau du Campus.</para>

  <para>Il faut aussi noter que le routage des paquets <acronym>IP</acronym>
  doit être activé sur le système. Dans le contexte présenté, cette condition
  est déjà remplie puisqu'il s'agit justement d'un routeur. On valide le
  routage au niveau du noyau Linux dans l'arborescence <filename
  class='directory'>/proc/</filename> ou via le fichier
  <filename>/etc/sysctl.conf</filename> s'il s'agit d'une configuration
  permanente.</para>

<screen width='80'>$ cat /proc/sys/net/ipv4/ip_forward
1

$ cat /etc/sysctl.conf |grep ip_forward
net/ipv4/ip_forward=1
#net/ipv6/ip_forward=1</screen>

  <para>À partir de ces deux conditions de base, il faut intégrer
  l'interception de trafic dans le fonctionnement global du système de
  filtrage. Voici un exemple fonctionnel de script
  <application>iptables</application> restreint à l'interception Web.</para>

<screen width='80'>#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                    
# NAT                                                                  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                    
*nat                                                                   
:PREROUTING ACCEPT [0:0]                                               
:POSTROUTING ACCEPT [0:0]                                              
:OUTPUT ACCEPT [0:0]                                                   
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                    
#  P O S T R O U T I N G                                               
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                    
-A POSTROUTING -o eth0 -p tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1400:1536 -j TCPMSS --clamp-mss-to-pmtu
-A POSTROUTING -o eth0 -j SNAT --to-source aaa.bbb.ccc.ddd
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                          
#  P R E R O U T I N G                                                                                       
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                          
# NTP postes clients                                                                                         
-A PREROUTING -i eth1+ -p udp --dport 123 -j REDIRECT --to-port 123                                          
# Interception du trafic Web des postes clients                                                              
-A PREROUTING -i eth1+ -p tcp --dport 80 -j REDIRECT --to-port 3128                                       
COMMIT                                                                                                       
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                          
#  N e t f i l t e r                                                                                         
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                          
*filter                                                                                                      
:INPUT DROP [0:0]                                                                                            
:FORWARD DROP [0:0]                                                                                          
:OUTPUT ACCEPT [0:0]                                                                                         
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                          
#  I N P U T                                                                                                 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                          
# Suivi de communication chaîne INPUT                                                                        
-A INPUT -p icmp -m conntrack --ctstate ESTABLISHED -j ACCEPT                                                      
-A INPUT -p icmp --icmp-type destination-unreachable -m conntrack --ctstate RELATED -j ACCEPT                      
-A INPUT -p icmp --icmp-type time-exceeded -m conntrack --ctstate RELATED -j ACCEPT                                
-A INPUT -p ospf -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT                                              
-A INPUT -p igmp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT                                              
-A INPUT -p udp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT                                               
-A INPUT -p tcp ! --syn -m conntrack --ctstate ESTABLISHED -j ACCEPT                                               
-A INPUT -p tcp --syn -m conntrack --ctstate RELATED -j ACCEPT                                                     
# Boucle locale                                                                                              
-A INPUT -i lo -j ACCEPT                                                                                     
# NTP                                                                                                        
-A INPUT -i eth1+ -p udp --dport 123 -m conntrack --ctstate NEW -j ACCEPT                                          
# WWW                                                                                                                   
-A INPUT -i eth1+ -p tcp --syn --dport 80 -m conntrack --ctstate NEW -j ACCEPT                                                
-A INPUT -i eth1+ -p tcp --syn --dport 443 -m conntrack --ctstate NEW -j ACCEPT                                               
# proxy Web                                                                                                             
-A INPUT -i eth1+ -p tcp --syn --dport 3128 -m conntrack --ctstate NEW -j ACCEPT                                              
# Poubelle
-A INPUT -m conntrack --ctstate INVALID -m limit --limit 5/min -j LOG --log-prefix "INPUT/rejected.iptables: "                     
-A INPUT -m conntrack --ctstate INVALID -j DROP                                                                                    
-A INPUT -p tcp -j REJECT --reject-with tcp-reset                                                                            
-A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable                                                                
-A INPUT -j LOG --log-prefix "INPUT/poubelle: "                                                                              
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                                          
#  F O R W A R D                                                                                                             
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                                          
# Suivi de communication chaîne FORWARD                                                                                      
-A FORWARD -p icmp -m conntrack --ctstate ESTABLISHED -j ACCEPT                                                                    
-A FORWARD -p icmp -m conntrack --ctstate RELATED --icmp-type destination-unreachable -j ACCEPT                                    
-A FORWARD -p icmp -m conntrack --ctstate RELATED --icmp-type time-exceeded -j ACCEPT                                              
-A FORWARD -p ospf -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT                                                            
-A FORWARD -p udp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT                                                             
-A FORWARD -p tcp -m conntrack --ctstate ESTABLISHED -m tcp ! --syn -j ACCEPT                                                      
-A FORWARD -p tcp -m conntrack --ctstate RELATED -m tcp --syn -j ACCEPT                                                            
# Boucle locale                                                                                                              
-A FORWARD -i lo -j ACCEPT                                                                                                   
# Salles de TP                                                                                                               
-A FORWARD -i eth1+ -p tcp -m tcp --syn --sport 1024: -m conntrack --ctstate NEW -j ACCEPT                                         
-A FORWARD -i eth1+ -p udp --sport 1024: -m conntrack --ctstate NEW -j ACCEPT                                                      
-A FORWARD -i eth1+ -p icmp --icmp-type echo-request -m limit --limit 5/sec -m conntrack --ctstate NEW -j ACCEPT                   
# Poubelle
-A FORWARD -m conntrack --ctstate INVALID -m limit --limit 5/min -j LOG --log-prefix "FORWARD/rejected.iptables: "
-A FORWARD -m conntrack --ctstate INVALID -j DROP
-A FORWARD -p tcp -j REJECT --reject-with tcp-reset
-A FORWARD -p udp -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -j LOG --log-prefix "FORWARD/poubelle: "
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#  O U T P U T
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Règles anti-fuites
-A OUTPUT -o eth0 -p tcp --dport 135:139 -j DROP
-A OUTPUT -o eth0 -p tcp --dport 445 -j DROP
-A OUTPUT -o eth0 -p udp --dport 135:139 -j DROP
-A OUTPUT -o eth0 -p udp --dport 445 -j DROP
-A OUTPUT -o eth0 -p tcp --dport 25 -j DROP
-A OUTPUT -o eth0 -p tcp -m multiport --sports 20,21,23,25,53,80,110,113 -j DROP
-A OUTPUT -o eth0 -s 127.0.0.0/8 -j LOG --log-prefix "OUTPUT/rejected.nat: "
-A OUTPUT -o eth0 -s 127.0.0.0/8 -j DROP
-A OUTPUT -o eth0 -s 10.0.0.0/8 -j LOG --log-prefix "OUTPUT/rejected.nat: "
-A OUTPUT -o eth0 -s 10.0.0.0/8 -j DROP
-A OUTPUT -o eth0 -s 172.16.0.0/12 -j LOG --log-prefix "OUTPUT/rejected.nat: "
-A OUTPUT -o eth0 -s 172.16.0.0/12 -j DROP
-A OUTPUT -o eth0 -s 192.168.0.0/16 -j LOG --log-prefix "OUTPUT/rejected.nat: "
-A OUTPUT -o eth0 -s 192.168.0.0/16 -j DROP
-A OUTPUT -o eth0 -s 224.0.0.0/8 -j DROP
-A OUTPUT -m conntrack --ctstate INVALID -j LOG --log-prefix "OUTPUT/rejected.iptables: "
-A OUTPUT -m conntrack --ctstate INVALID -j DROP
COMMIT</screen>

  <para>Sur le système illustré, ce script nommé <filename>active</filename>
  est placé dans le répertoire <filename
  class='directory'>/var/lib/iptables/</filename>. On applique les règles
  contenues dans ce fichier à l'aide de la commande
  <userinput><prompt>#</prompt> iptables-restore
  &lt;/var/lib/iptables/active</userinput>.</para>

  <para>Pour plus de détails sur la rédaction de ce genre de script, on peut
  consulter le support <link
  xlink:href='http://www.inetdoc.net/travaux_pratiques/interco.netfilter/'>Introduction
  au filtrage réseau</link> et surtout le <link
  xlink:href='http://www.inetdoc.net/guides/iptables-tutorial/'>Tutoriel
  Iptables</link>.</para>

  <para>Pour valider le fonctionnement de l'interception de trafic Web, il
  suffit de visualiser les compteurs de paquets pour lesquels il y a eu
  correspondance avec une règle de filtrage.</para>

  <itemizedlist>
    <listitem>
    <para>Pour la règle d'interception proprement dite, le compte des paquets
    traités dans la chaîne <option>PREROUTING</option> doit évoluer.</para>

<screen width='80'># iptables -t nat -vL PREROUTING | grep REDIRECT
16  1216 REDIRECT   udp  --  eth1+  any  anywhere  anywhere   udp dpt:ntp redir ports 123
11   528 REDIRECT   tcp  --  eth1+  any  anywhere  anywhere   tcp dpt:www redir ports 3128</screen>
    </listitem>

    <listitem>
    <para>Pour l'utilisation du service mandataire Web
    <wordasword>proxy</wordasword>, on doit retrouver le même compte du nombre
    de paquets dans la chaîne <option>INPUT</option>.</para> 

<screen width='80'># iptables -vL INPUT |grep 3128
11   528 ACCEPT     tcp  --  eth1+  any  anywhere  anywhere   tcp dpt:3128 flags:FIN,SYN,RST,ACK/SYN state NEW</screen>
    </listitem>

    <listitem>
    <para>Enfin, les journaux doivent montrer qu'il y a bien eu sollicitation
    du service.</para>

<screen width='80'># tail /var/log/squid3/access.log
1226421464.379  60869 172.16.48.64 TCP_MISS/200 925 POST \
  http://update.microsoft.com/v6/UpdateRegulationService/UpdateRegulation.asmx \
  - DIRECT/207.46.17.93 text/xml
1226422061.838     48 172.16.48.65 TCP_MISS/200 407 HEAD \
  http://download.windowsupdate.com/v8/windowsupdate/redir/muv3wuredir.cab? \
  - DIRECT/204.160.98.121 application/octet-stream
1226422062.528    670 172.16.48.65 TCP_MISS/200 407 HEAD \
  http://update.microsoft.com/v8/windowsupdate/selfupdate/wuident.cab? \ 
  - DIRECT/65.55.184.93 application/octet-stream
1226422062.563     24 172.16.48.65 TCP_MISS/200 408 HEAD \
  http://download.windowsupdate.com/v8/windowsupdate/a/selfupdate/WSUS3/x86/Other/wsus3setup.cab? \
  - DIRECT/204.160.98.121 application/octet-stream
1226422062.680    114 172.16.48.65 TCP_MISS/200 25492 GET \
  http://download.windowsupdate.com/v8/windowsupdate/a/selfupdate/WSUS3/x86/Other/wsus3setup.cab? \
  - DIRECT/204.160.98.121 application/octet-stream
1226422065.039     24 172.16.48.65 TCP_REFRESH_UNMODIFIED/200 405 HEAD \
  http://download.windowsupdate.com/v8/windowsupdate/redir/muv3wuredir.cab? \
  - DIRECT/204.160.98.121 application/octet-stream
1226422069.106     35 172.16.48.65 TCP_REFRESH_UNMODIFIED/200 406 HEAD \
  http://download.windowsupdate.com/v8/windowsupdate/redir/muv3wuredir.cab? \
  - DIRECT/205.128.69.124 application/octet-stream</screen>
    </listitem>
  </itemizedlist>
</section>

<section xml:id='squid-guard.conclusion'>
  <title>Pour conclure, en attendant la suite</title>

  <para>Être parvenu jusqu'à la lecture de cette ligne de ce billet relève déjà
  de l'exploit ! Ce billet est bien trop long et l'objectif de
  sécurisation n'est pas encore atteint. Pour autant, on dispose d'un service
  fonctionnel avec filtrage des <acronym>URL</acronym>s. C'est la raison pour
  laquelle on s'arrête ici en attendant la rédaction du volet authentification
  et sécurisation du dialogue entre le navigateur du poste client et le service
  Web mandataire.</para>

  <para>En espérant que vous aurez trouvé les informations de ce billet
  pertinentes !</para>
</section>
</article>
