<?xml version='1.0'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
        "/usr/share/xml/docbook/schema/dtd/5.0/docbook.dtd" [

<!ENTITY author		SYSTEM "author.xml">
<!ENTITY legal		SYSTEM "legal.xml">

<!ENTITY % inetdoc_urls SYSTEM 'inetdoc.urls.xml'>
%inetdoc_urls;

<!ENTITY url.bonding
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.linuxfoundation.org/collaborate/workgroups/networking/bonding">
   <citetitle>bonding</citetitle></link>'>

<!ENTITY url.etherchannel
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.cisco.com/en/US/tech/tk389/tk213/technologies_white_paper09186a0080092944.shtml">
   <citetitle>etherchannel</citetitle></link>'>

<!ENTITY url.multipath
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://sources.redhat.com/lvm2/wiki/MultipathUsageGuide">
   <citetitle>multipath</citetitle></link>'>

<!ENTITY url.open-iscsi
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.open-iscsi.org/">
   <citetitle>Open-iSCSI</citetitle></link>'>

<!ENTITY url.iscsitarget
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://iscsitarget.sourceforge.net/">
   <citetitle>iSCSI Enterprise Target</citetitle></link>'>

<!ENTITY url.usingparted
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.gnu.org/software/parted/manual/html_node/Using-Parted.html#Using-Parted">
   <citetitle>Using Parted</citetitle></link>'>

<!ENTITY url.ext4howto
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="https://ext4.wiki.kernel.org/index.php/Ext4_Howto">
   <citetitle>Ext4 Howto</citetitle></link>'>

<!ENTITY url.iscsi.debian.wiki
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://wiki.debian.org/SAN/iSCSI">
   <citetitle>iSCSI and Debian</citetitle></link>'>

<!ENTITY url.iscsi.linux-mag.introduction
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.linux-mag.com/id/7605/">
   <citetitle>Introduction to iSCSI</citetitle></link>'>

<!ENTITY url.iscsi.unixgarden
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://www.unixgarden.com/index.php/administration-reseau/le-support-du-protocole-iscsi-dans-linux">
   <citetitle>Le support du protocole iSCSI dans Linux</citetitle></link>'>

<!ENTITY url.sparse_file
   '<link xmlns="http://docbook.org/ns/docbook" xlink:href="http://en.wikipedia.org/wiki/Sparse_file">
   <citetitle>Sparse file</citetitle></link>'>
]>

<article xml:id='sysadm-net.iscsi.qa' xml:lang='fr'>

<info>
  <title>Introduction au réseau de stockage iSCSI</title>

  &author;
  <abstract>
    <para>Ce support de travaux pratiques est consacré à l'étude d'une
    infrastructure de stockage illustrant les technologies DAS (Direct Attached
    Storage), SAN (Storage Area Network) et la redondance de niveau 1 (RAID1).
    La technologie iSCSI est utilisée pour la partie SAN, c'est un exemple
    d'accès «en mode bloc» aux unités de stockage réseau. La redondance de
    niveau 1 utilise les fonctions intégrées au noyau Linux. L'infrastructure
    proposée montre comment les différentes technologies élémentaires peuvent
    être combinées pour atteindre les objectifs de haute disponibilité et de
    sauvegarde.</para>
  </abstract>

  <keywordset>
    <keyword>DAS</keyword>
    <keyword>debian</keyword>
    <keyword>dkms</keyword>
    <keyword>iscsi</keyword>
    <keyword>initiator</keyword>
    <keyword>linux</keyword>
    <keyword>mdadm</keyword>
    <keyword>RAID</keyword>
    <keyword>SAN</keyword>
    <keyword>target</keyword>
  </keywordset>
</info>

<sect1 xml:id='sysadm-net.iscsi.qa.legal.meta'>
  &legal;

  <sect2 xml:id='sysadm-net.iscsi.qa.meta'>
    <title>Méta-information</title>
    
  <para>Ce document est écrit avec <link
  xlink:href="http://www.docbook.org"><citetitle>DocBook</citetitle></link> XML
  sur un système <link xlink:href="http://www.debian.org"><citetitle>Debian
  GNU/Linux</citetitle></link>. Il est disponible en version imprimable au
  format PDF : <link
  xlink:href="http://www.inetdoc.net/pdf/__printbasename__"><literal>__printbasename__</literal></link>.</para>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.convtypo'>
    <title>Conventions typographiques</title>

  <para>Tous les exemples d'exécution des commandes sont précédés d'une invite
  utilisateur ou <wordasword>prompt</wordasword> spécifique au niveau des
  droits utilisateurs nécessaires sur le système.</para>

  <itemizedlist>
    <listitem>
    <para>Toute commande précédée de l'invite <prompt>$</prompt> ne nécessite
    aucun privilège particulier et peut être utilisée au niveau utilisateur
    simple.</para>
    </listitem>
    <listitem>
    <para>Toute commande précédée de l'invite <prompt>#</prompt> nécessite les
    privilèges du super-utilisateur.</para>
    </listitem>
  </itemizedlist>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.affectation'>
  <title>Adressage IP des postes de travail</title>

  <para>À partir de l'infrastructure proposée dans la <link
  linkend='sysadm-net.iscsi.qa.topology'>section suivante</link>, on constitue
  des couples de postes de travail qui vont partager le même domaine de
  diffusion durant la séance de travaux pratiques.</para>

  <para>Ces opérations de réaffectation du plan d'adressage
  <acronym>IP</acronym> sont répétées à chaque début de séance de travaux
  pratiques. Elles s'appuient sur les indications données dans le document
  &url.infra.tp;.</para>

  <table frame='all' pgwide='1'>
    <title>Affectation des adresses et des réseaux IP</title>
    <tgroup cols='3' align='left' colsep='1' rowsep='1'>
    <thead>
      <row>
      <entry> Poste 1</entry>
      <entry> Poste 2</entry>
      <entry> Passerelle par défaut</entry>
      </row>
    </thead>
    <tbody>
      <row>
      <entry>alderaan</entry>
      <entry>bespin</entry>
      <entry><systemitem class='ipaddress'>10.4.4.1/23</systemitem></entry>
      </row>
      <row>
      <entry>centares</entry>
      <entry>coruscant</entry>
      <entry><systemitem class='ipaddress'>192.168.109.1/25</systemitem></entry>
      </row>
      <row>
      <entry>dagobah</entry>
      <entry>endor</entry>
      <entry><systemitem class='ipaddress'>10.0.117.1/27</systemitem></entry>
      </row>
      <row>
      <entry>felucia</entry>
      <entry>geonosis</entry>
      <entry><systemitem class='ipaddress'>10.7.10.1/23</systemitem></entry>
      </row>
      <row>
      <entry>hoth</entry>
      <entry>mustafar</entry>
      <entry><systemitem class='ipaddress'>172.19.112.1/26</systemitem></entry>
      </row>
      <row>
      <entry>naboo</entry>
      <entry>tatooine</entry>
      <entry><systemitem class='ipaddress'>192.168.111.1/25</systemitem></entry>
      </row>
    </tbody>
    </tgroup>
  </table>

  <para>Une fois la passerelle du réseau IP affecté à chaque paire de postes de
  travaux pratiques, il faut rechercher dans le document &url.infra.tp; les
  éléments nécessaires à la connexion physique de ces postes. Les étapes
  usuelles sont les suivantes :</para>

  <orderedlist>
    <listitem>
    <para>Attribuer une adresse IP à chacun des postes en fonction de l'espace
    d'adressage du réseau défini.</para>
    </listitem>
    <listitem>
    <para>Rechercher le numéro de VLAN correspondant au réseau IP
    attribué.</para>
    </listitem>
    <listitem>
    <para>Repérer le commutateur sur lequel des ports ont été affectés au VLAN
    recherché. Connecter les deux postes de travaux pratiques sur les ports
    identifiés.</para>
    </listitem>
    <listitem>
    <para>Configurer les interfaces réseau de chaque poste : adresse,
    masque et passerelle par défaut. Valider la connectivité IP entre les deux
    postes puis avec les autres réseaux de l'infrastructure de travaux
    pratiques.</para>
    </listitem>
  </orderedlist>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.topology'>
  <title>Technologie iSCSI et topologie de travaux pratiques</title>
    
  <para>Cette section présente sommairement la technologie
  <acronym>iSCSI</acronym> et a pour but d'attribuer les rôles et les tâches de
  chacun des postes de travaux pratiques en fonction de la topologie mise en
  œuvre. Ce support de travaux pratiques fait suite à la présentation sur le
  &url.storage; utilisée en cours.</para>

  <sect2 xml:id='sysadm-net.iscsi.qa.topology.techno'>
    <title>Bases de la technologie iSCSI</title>

  <mediaobject>
    <imageobject>
    <imagedata fileref='images/topologie-iscsi.png' format='PNG' contentwidth='15cm' width='15.5cm'/>
    </imageobject>
    <textobject>
    <phrase>Topologie iSCSI basique</phrase>
    </textobject>
    <caption>
    <para><link xmlns="http://docbook.org/ns/docbook" xlink:href='http://www.inetdoc.net/travaux_pratiques/sysadm-net.iscsi.qa/images/topologie-iscsi.png'>
    Topologie iSCSI basique - vue complète</link></para>
    </caption>
  </mediaobject>

  <para>La technologie <acronym>iSCSI</acronym> dont l'acronyme reprend la
  définition historique <wordasword>Internet Small Computer System
  Interface</wordasword> est un protocole réseau de stockage basé sur le modèle
  <acronym>TCP/IP</acronym>. Le principe de base consiste à encapsuler des
  commandes <acronym>SCSI</acronym> dans des paquets <acronym>IP</acronym>
  transmis entre un hôte et une unité de disque. Comme les paquets
  <acronym>IP</acronym> peuvent être perdus (et|ou) retransmis, ils peuvent
  très bien ne pas arriver dans l'ordre d'émission. Le protocole
  <acronym>iSCSI</acronym> doit donc conserver une trace de la séquence de
  transmission de commandes <acronym>SCSI</acronym>. Les commandes sont placées
  dans une file d'attente dans l'ordre d'émission.</para>

  <para>La technologie <acronym>iSCSI</acronym> a initialement été développée
  par <citetitle>IBM</citetitle> et a ensuite été soumise à
  l'<acronym>IETF</acronym> (<wordasword>Internet Engineering Task
  Force</wordasword>). Le standard a été publié par le comité <wordasword>IP
  Storage Working Group</wordasword> en août 2002.</para>

  <para>On peut identifier deux fonctions principales dans la technologie
  <acronym>iSCSI</acronym>. La première est la fonction
  <wordasword>target</wordasword>. C'est un système simple qui contient l'unité
  de disque. Ce système peut être matériel ou logiciel. Dans le cas de ces
  travaux pratiques, il s'agit d'un poste de travail utilisant son second
  disque dur comme unité de stockage <acronym>SAN</acronym>. La seconde
  fonction est baptisée <wordasword>initiator</wordasword>. Elle correspond au
  «client» qui utilise l'unité de stockage réseau. Ici, l'autre poste de
  travaux pratiques joue ce rôle de client.</para>

  <para>Fondamentalement, <acronym>iSCSI</acronym> est un protocole de la
  famille <wordasword>Storage Area Network</wordasword>
  (<acronym>SAN</acronym>). Le client ou <wordasword>initiator</wordasword>
  accède à une unité de stockage en <emphasis>mode bloc</emphasis>. Ce mode de
  fonctionnement est quasi identique à la technologie <wordasword>Fibre
  Channel</wordasword>. Le type de réseau constitue la principale différence
  entre ces deux technologies. La technologie <acronym>iSCSI</acronym> s'appuie
  sur <acronym>TCP/IP</acronym> alors que <wordasword>Fibre
  Channel</wordasword> comprend une définition de réseau propre
  (<acronym>FC</acronym>) qui nécessite des équipements spécifiques.</para>

  <para>Ces dernières années, la technologie <acronym>iSCSI</acronym> gagne en
  popularité relativement à son ainée pour plusieurs raisons.</para>

  <itemizedlist>
    <listitem>
    <para>Le prix des configurations <acronym>iSCSI</acronym> peut être bien
    meilleur marché qu'avec la technologie <wordasword>Fibre
    Channel</wordasword>. Si les performances d'un réseau au Gigabit Ethernet
    suffisent, un réseau de stockage <acronym>iSCSI</acronym> devient très
    attractif.</para>

    <para>Attention cependant à bien identifier quand d'autres techniques sont
    associées à <acronym>iSCSI</acronym> pour accroître les débits réseau et
    donc les performances du stockage. Dans ces techniques complémentaires on
    trouve l'agrégation de canaux baptisée &url.bonding; sur les systèmes
    GNU/Linux et &url.etherchannel; sur les équipements
    <citetitle>Cisco</citetitle>. Sous ces deux dénominations différentes se
    cache un même standard : l'IEEE 802.3ad <wordasword>Dynamic link
    aggregation</wordasword> qui rend l'utilisation de cette technique
    totalement transparente entre équipements hétérogènes. En appliquant ce
    principe d'agrégation de canaux, on peut pratiquement assimiler les
    performances de quatre liens Gigabit Ethernet à celles d'un lien
    <wordasword>Fibre Channel</wordasword>. Une autre technique consiste à
    utiliser aussi plusieurs liens dans une optique et redondance et de balance
    de charge. Elle est appelée &url.multipath;.</para>
    </listitem>
    <listitem>
    <para>L'utilisation d'une technologie réseau unique est nettement moins
    complexe à administrer. En effet, on optimise les coûts, les temps de
    formation et d'exploitation en utilisant une architecture de commutation
    homogène. C'est un des avantages majeurs de la technologie Ethernet sur ses
    concurrentes.</para>
    </listitem>
    <listitem>
    <para>Au début de son exploitation, le coût d'un réseau 10 Gigabit Ethernet
    est prohibitif relativement à toutes les autres solutions. On peut espérer
    que le coût d'acquisition des équipements 10GigE suivra le même profil que
    pour les débits antérieurs et que ces réseaux vont se démocratiser. Du
    point de vue hôte, le point déterminant est l'uniformisation de l'interface
    réseau. En effet, avec une interface 10GigE on ne devrait plus avoir de
    distinction entre <acronym>NIC</acronym> et <acronym>HBA</acronym>.</para>
    </listitem>
  </itemizedlist>

  <para>Aujourd'hui la technologie <acronym>iSCSI</acronym> est supportée par
  tous les systèmes d'exploitation communs. Côté GNU/Linux, plusieurs projets
  ont vu le jour dans les années qui ont suivi la publication du standard en
  2002. Pour la partie <wordasword>initiator</wordasword> les développements
  des deux projets phares ont fusionné pour ne plus fournir qu'un seul code
  source ; celui disponible à l'adresse &url.open-iscsi;. La partie
  <wordasword>target</wordasword> a suivi un processus analogue et le code
  source est disponible à l'adresse &url.iscsitarget;. On peut simplement
  regretter que la partie <wordasword>Kernelspace</wordasword> n'ait pas encore
  été intégrée dans l'arborescence principale du noyau Linux. La mise en œuvre
  du rôle <wordasword>target</wordasword> nécessite donc des manipulations
  spécifiques pour compiler les modules si le système d'exploitation ne fournit
  pas le service <acronym>DKMS</acronym> (<wordasword>Dynamic Kernel Module
  Support</wordasword>).</para> 

  <para>On retrouve tous les éléments utiles sous forme de paquets dans la
  distribution Debian GNU/Linux.</para>

<screen width='80'><prompt>$</prompt> aptitude search iscsi
p   iscsitarget       - iSCSI Enterprise Target userland tools
p   iscsitarget-dkms  - iSCSI Enterprise Target kernel module source - dkms version
p   libiscsi-bin      - iSCSI client shared library - utilities
p   libiscsi-dev      - iSCSI client shared library
p   libiscsi1         - iSCSI client shared library
p   open-iscsi        - High performance, transport independent iSCSI implementation</screen>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.topology.infrastructure'>
    <title>Infrastructure de stockage étudiée</title>

  <para>Le séquencement des opérations à réaliser lors de la séance de travaux
  pratiques est décrit dans le tableau ci-dessous. Les deux postes occupent
  chacun un rôle distinct. Comme le rôle <wordasword>initiator</wordasword>
  demande moins de travail de préparation, c'est à ce poste que l'on confie les
  essais des outils de <wordasword>micro-benchmark</wordasword>.</para>

  <table frame='all' pgwide='1'>
    <title>Attribution des rôles</title>
    <tgroup cols='2' align='left' colsep='1' rowsep='1'>
    <colspec colnum='1' colname='c1' colwidth='1*'/>
    <colspec colnum='2' colname='c2' colwidth='1*'/>
    <thead>
      <row>
      <entry>Rôle <wordasword>initiator</wordasword></entry>
      <entry>Rôle <wordasword>target</wordasword></entry>
      </row>
    </thead>
    <tbody>
      <row>
      <entry>Préparation d'une unité de stockage locale pour évaluer les
      différences entre les accès <acronym>DAS</acronym> et
      <acronym>SAN</acronym></entry>
      <entry>Préparation d'une unité de stockage
      <acronym>iSCSI</acronym></entry>
      </row>
      <row>
      <entry namest='c1' nameend='c2' align='center'>Installation des
      outils</entry>
      </row>
      <row>
      <entry>Mise au point des scripts d'évaluation des performances du
      stockage</entry>
      <entry>Compilation et configuration des outils de déploiement d'une unité
      de stockage <acronym>iSCSI</acronym></entry>
      </row>
      <row>
      <entry namest='c1' nameend='c2' align='center'>Validation de la
      configuration <acronym>SAN</acronym> <acronym>iSCSI</acronym></entry>
      </row>
      <row>
      <entry namest='c1' nameend='c2' align='center'>Étude comparative des
      performances</entry>
      </row>
    </tbody>
    </tgroup>
  </table>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.storage'>
  <title>Préparation d'une unité de stockage</title>

  <para>Dans cette section on présente les manipulations à effectuer pour
  préparer une unité de stockage à son utilisation dans une configuration
  <acronym>DAS</acronym> (et|ou) <acronym>SAN</acronym>.</para>

<warning>
  <para>Les commandes données dans les réponses correspondent à l'utilisation
  de machines virtuelles. Les unités de disques apparaissent donc sous le nom
  <option>/dev/vd[a-z]</option>. Les unités de disques physiques d'un système
  réel apparaissent sous le nom <option>/dev/sd[a-z]</option>.</para> 
</warning>

  <sect2 xml:id='sysadm-net.iscsi.qa.storage.blank'>
    <title>Destruction de la table des partitions</title>

  <para>Sachant que les disques des postes de travaux pratiques sont utilisés
  régulièrement, il est préférable de se placer dans le contexte d'utilisation
  d'une unité de disque vierge de tout système de fichiers.</para>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para><phrase>Quelle est la syntaxe d'appel de l'outil
      <application>parted</application> qui permet de visualiser la table de
      partition d'une unité de disque ?</phrase></para>

      <para>Consulter la documentation de <application>parted</application> à
      l'adresse &url.usingparted;.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> parted /dev/vda print
Model: Virtio Block Device (virtblk)
Disk /dev/vda: 34,4GB
Sector size (logical/physical): 512B/512B
Partition Table: msdos

Number  Start   End     Size    Type      File system  Flags
 1      1049kB  256MB   255MB   primary   ext2         boot
 2      257MB   34,4GB  34,1GB  extended
 5      257MB   34,4GB  34,1GB  logical                lvm</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est la syntaxe de la commande <command>dd</command>
      qui permet d'effacer complètement la table des partitions d'une unité de
      disque ?</phrase></para>

      <para>Utiliser l'aide en ligne de la commande : <userinput>dd
      --help</userinput>.</para>
    </question>
    <answer>
    <para>La commande suivante écrit des 0 dans les 4 premiers blocs de 512 octets de l'unité de disque.</para>

<screen width='80'><prompt>#</prompt> dd if=/dev/zero of=/dev/vdb bs=512 count=4
4+0 enregistrements lus
4+0 enregistrements écrits
2048 octets (2,0 kB) copiés, 0,00135867 s, 1,5 MB/s

<prompt>#</prompt> parted  /dev/vdb print
Error: /dev/vdb: unrecognised disk label</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.storage.setup'>
    <title>Création de la table des partitions et formatage</title>

  <para>Une fois que l'on dispose d'une unité de disque vierge, on peut passer
  à l'étape de création de la table des partitions. Dans le contexte de ces
  travaux pratiques, cette opération doit être effectuée deux fois sur les
  postes de travail pour les deux types d'unité de stockage utilisées.</para>

  <orderedlist>
    <listitem>
    <para>Le second disque physique des postes de travail est destiné à
    intégrer l'unité logique <acronym>RAID1</acronym>.</para>
    </listitem>
    <listitem>
    <para>Le disque réseau iSCSI est disponible une fois que la configuration
    du rôle <wordasword>initiator</wordasword> est active.</para>
    </listitem>
  </orderedlist>
  
  <para>Cette manipulation est l'opération de plus bas niveau qui caractérise
  un accès réseau au stockage en <emphasis>mode bloc</emphasis> et non en mode
  fichier.</para>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para><phrase>Quelles sont les instructions de l'outil
      <application>parted</application> qui permettent de créer une partition
      primaire unique couvrant la totalité de l'espace de stockage de l'unité
      de disque ?</phrase></para>

      <para>Consulter la documentation de <application>parted</application> à
      l'adresse &url.usingparted;.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> parted /dev/vdb
GNU Parted 2.3
Using /dev/vdb
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) <emphasis>print</emphasis>
Error: /dev/vdb: unrecognised disk label
(parted) <emphasis>mklabel gpt</emphasis>
(parted) <emphasis>print</emphasis>
Model: Virtio Block Device (virtblk)
Disk /dev/vdb: 85,9GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt

Number  Start  End  Size  File system  Name  Flags

(parted) <emphasis>mkpart ext4 1 -1</emphasis>
(parted) <emphasis>print</emphasis>
Model: Virtio Block Device (virtblk)
Disk /dev/vdb: 85,9GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt

Number  Start   End     Size    File system  Name  Flags
 1      1049kB  85,9GB  85,9GB  ext4         ext4

(parted) quit</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est la commande à utiliser pour les opérations de
      formatage ? Quel est le rôle de l'option <option>-T</option> de cette
      commande ?</phrase></para>

      <para>Les informations utiles sont disponibles à la page &url.ext4howto;.
      Les pages de manuels détaillent les fonctions des options.</para>
    </question>
    <answer>
      <para>La commande utilisée pour le formatage d'un système de fichiers
      <option>ext4</option>.</para>

<screen width='80'><prompt>#</prompt> dpkg -S `which mkfs.ext4`
e2fsprogs: /sbin/mkfs.ext4</screen>

      <para>L'option <option>-T</option> définit le type d'utilisation du
      système de fichiers à formater suivant sa taille. Les paramètres par
      défaut sont les suivants :</para>

      <itemizedlist>
        <listitem>
	<para><option>floppy</option> : 0 &lt; taille &lt; 3Mo</para>
	</listitem>
	<listitem>
	<para><option>small</option> : 3Mo &lt; taille &lt; 512Mo</para>
	</listitem>
	<listitem>
	<para><option>default</option> : 512Mo &lt; taille &lt; 4To</para>
	</listitem>
	<listitem>
	<para><option>big</option> : 4To &lt; taille &lt; 16To</para>
	</listitem>
	<listitem>
	<para><option>huge</option> : 16To &lt; taille</para>
	</listitem>
      </itemizedlist>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est la syntaxe de la commande de formatage de la
      partition créée lors de l'étape précédente ?</phrase></para>

      <para>Des exemples de syntaxe sont disponibles à la page
      &url.ext4howto;.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> <emphasis>mkfs.ext4 /dev/vdb1</emphasis>
mke2fs 1.42.5 (29-Jul-2012)
Étiquette de système de fichiers=
Type de système d'exploitation : Linux
Taille de bloc=4096 (log=2)
Taille de fragment=4096 (log=2)
« Stride » = 0 blocs, « Stripe width » = 0 blocs
5242880 i-noeuds, 20971008 blocs
1048550 blocs (5.00%) réservés pour le super utilisateur
Premier bloc de données=0
Nombre maximum de blocs du système de fichiers=4294967296
640 groupes de blocs
32768 blocs par groupe, 32768 fragments par groupe
8192 i-noeuds par groupe
Superblocs de secours stockés sur les blocs : 
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
        4096000, 7962624, 11239424, 20480000

Allocation des tables de groupe : complété
Écriture des tables d'i-noeuds : complété
Création du journal (32768 blocs) : complété
Écriture des superblocs et de l'information de comptabilité du système de
fichiers : complété</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est la syntaxe de la commande de visualisation des attributs
      du système de fichiers créé lors du formatage ?</phrase></para>

      <para>Les informations utiles sur les attributs sont fournies à la page
      &url.ext4howto;.</para>
    </question>
    <answer>

<screen width='80'><prompt>#</prompt> <emphasis>tune2fs -l /dev/vdb1</emphasis>
tune2fs 1.42.5 (29-Jul-2012)
Filesystem volume name:   &lt;none>
Last mounted on:          &lt;not available>
Filesystem UUID:          224f6aad-16c0-4923-8949-0628a8e10228
Filesystem magic number:  0xEF53
Filesystem revision #:    1 (dynamic)
Filesystem features:      has_journal ext_attr resize_inode dir_index \
                          filetype extent flex_bg sparse_super large_file \
			  huge_file uninit_bg dir_nlink extra_isize
Filesystem flags:         signed_directory_hash 
Default mount options:    user_xattr acl
Filesystem state:         clean
Errors behavior:          Continue
Filesystem OS type:       Linux
Inode count:              5242880
Block count:              20971008
Reserved block count:     1048550
Free blocks:              20594924
Free inodes:              5242869
First block:              0
Block size:               4096
Fragment size:            4096
Reserved GDT blocks:      1019
Blocks per group:         32768
Fragments per group:      32768
Inodes per group:         8192
Inode blocks per group:   512
Flex block group size:    16
Filesystem created:       Wed Sep  5 19:25:31 2012
Last mount time:          n/a
Last write time:          Wed Sep  5 19:25:34 2012
Mount count:              0
Maximum mount count:      -1
Last checked:             Wed Sep  5 19:25:31 2012
Check interval:           0 (&lt;none>)
Lifetime writes:          1412 MB
Reserved blocks uid:      0 (user root)
Reserved blocks gid:      0 (group root)
First inode:              11
Inode size:               256
Required extra isize:     28
Desired extra isize:      28
Journal inode:            8
Default directory hash:   half_md4
Directory Hash Seed:      14e590af-337a-483a-a36f-76f97263b601
Journal backup:           inode blocks</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.storage.imagefiles'>
    <title>Création de fichiers images des volumes de stockage</title>

  <para>Pour le système ayant le rôle <wordasword>target</wordasword>, il est
  possible de mettre à disposition sur le réseau des volumes de stockage de
  deux natures différentes. On peut dédier un volume de stockage physique ou
  constituer des fichiers images de volumes de stockage. C'est cette seconde
  option que nous utilisons dans le cadre de ces travaux pratiques.</para>

<warning>
  <para>Les manipulations demandées supposent que l'on ait préalablement
  vérifié que l'espace disque disponible est suffisant.</para>
</warning>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para><phrase>Quelle est la commande du paquet
      <application>coreutils</application> qui permet de réaliser des
      opérations de bas niveau sur les fichiers ?</phrase></para>

      <para>Utiliser la liste des fichiers du paquet pour repérer la commande à
      utiliser.</para>
    </question>
    <answer>
      <para>La commande à utiliser est <command>dd</command>.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est la syntaxe de la commande demandée dans la
      question précédente qui permet de créer un <wordasword>sparse
      file</wordasword> de 32Go constitué de blocs de 4Ko ? Donner le détail du
      calcul du nombre de blocs à allouer.</phrase></para>

      <para>Consulter la page &url.sparse_file;.</para>
    </question>
    <answer>
      <para>Dans l'exemple ci-dessous, on créé deux fichiers images de 32Go
      dans un volume ayant un espace libre de 75Go.</para>

<screen width='80'><prompt>#</prompt> df -h
Sys. fich.           Taille Util. Dispo Uti% Monté sur
rootfs                  30G  1,1G   28G   4% /
udev                    10M     0   10M   0% /dev
tmpfs                  202M  256K  202M   1% /run
/dev/mapper/vm0-root    30G  1,1G   28G   4% /
tmpfs                  5,0M     0  5,0M   0% /run/lock
tmpfs                  403M     0  403M   0% /run/shm
/dev/vda1              228M   20M  196M  10% /boot
<emphasis>/dev/vdb1               80G  1,4G   75G   2% /var/lib/iscsi-target</emphasis>

<prompt>#</prompt> cd /var/lib/iscsi-target/

<prompt>#</prompt> dd if=/dev/null of=1stInitiator.disk bs=4k seek=8388608

<prompt>#</prompt> dd if=/dev/null of=2ndInitiator.disk bs=4k seek=8388608</screen>

      <para>Pour le calcul du nombre de blocs à «escamoter», on divise la
      capacité voulue par la taille unitaire d'un bloc ; soit 32Go/4Ko ou
      :</para>

<screen width='80'>(32 x 1024 x 1024 x 1024) / (4 x 1024) = 8388608</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Comment caractériser l'espace disque effectivement occupé
      par un fichier image de volume de stockage ?</phrase></para>

      <para>Utiliser à nouveau la liste des fichiers du paquet
      <application>coreutils</application> pour repérer la ou les commandes de
      visualisation de l'occupation disque.</para>
    </question>
    <answer>
      <para>La commande <command>du</command> pour <wordasword>disk
      usage</wordasword> permet d'obtenir les informations sur l'occupation
      disque des fichiers. Dans la copie d'écran ci-dessous, on commence par
      afficher la taille définie suite à l'utilisation de la commande
      <command>dd</command> puis on utilise <command>du</command> pour
      visualiser l'espace occupé.</para>

<screen width='80'><prompt>#</prompt> ls -lAh *.disk
-rw-r--r-- 1 root root 32G sept.  6 11:26 1stInitiator.disk
-rw-r--r-- 1 root root 32G sept.  6 11:26 2ndInitiator.disk

<prompt>#</prompt> du -hs *.disk
0       1stInitiator.disk
0       2ndInitiator.disk</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.storage.mount'>
    <title>Montage manuel d'un volume de stockage</title>

  <para>Une fois qu'un volume de stockage a été partitionné et formaté, il faut
  le <emphasis>monter</emphasis> dans l'arborescence du système de fichiers de
  la machine de façon à lire et écrire des données dedans.</para>

  <qandaset>
    <qandaentry>
    <question>
      <para><phrase>Comment obtenir l'identifiant du volume de stockage à
      ajouter au système de fichiers ?</phrase></para>

      <para>Consulter la liste des utilitaires fournis avec le paquet
      <application>util-linux</application>. Il faut se rappeler que la
      représentation fichier d'un périphérique de stockage se distingue par son
      mode d'accès : le mode bloc.</para>
    </question>
    <answer>
      <para>La commande à utiliser est <command>blkid</command>. Dans l'exemple
      de la partition <systemitem>/dev/vdb1</systemitem>, on obtient le
      résultat suivant.</para>

<screen width='80'><prompt>#</prompt> blkid /dev/vdb1
/dev/vdb1: UUID="224f6aad-16c0-4923-8949-0628a8e10228" TYPE="ext4"</screen>

      <para>C'est cet identifiant que l'on doit utiliser pour compléter la
      configuration système et rendre le montage du périphérique de stockage
      permanent.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Dans quel fichier de configuration trouve-t-on la liste des
      périphériques montés lors de l'initialisation du système
      ?</phrase></para>

      <para>Consulter la liste des fichiers du paquet
      <application>util-linux</application>.</para>
    </question>
    <answer>
      <para>Le fichier recherché est <filename>/etc/fstab</filename>. Il
      contient bien la liste des points de montage. Dans l'exemple ci-dessous,
      l'arborescence virtuelle <filename class='directory'>/proc</filename>, la
      racine, la partition <filename class='directory'>/boot</filename>
      contenant les fichiers du noyau et la configuration du gestionnaire
      d'amorce et enfin la partition d'échange utilisée en cas de saturation
      des ressources <acronym>RAM</acronym> du système.</para>

<screen width='80'><prompt>#</prompt> grep -v '^#' /etc/fstab
proc                                      /proc  proc  defaults          0       0
/dev/mapper/vm0-root                      /      ext3  errors=remount-ro 0       1
UUID=15fb1316-1260-44bf-8931-ff052d99d315 /boot  ext2  defaults          0       2
/dev/mapper/vm0-swap_1                    none   swap  sw                0       0</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est la commande qui donne la liste des montages en
      cours d'utilisation sur le système ? Quelle est l'option qui permet de
      scruter les entrées du fichier recherché dans la question précédente et
      de monter tous les points non encore utilisés ?</phrase></para>
      
      <para>La commande est fournie par le paquet du même nom.</para>
    </question>
    <answer>
      <para>Le paquet <application>mount</application> fournit la commande du
      même nom. En reprenant l'exemple utilisé auparavant, on obtient :</para>

<screen width='80'><prompt>#</prompt> mount
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
udev on /dev type devtmpfs (rw,relatime,size=10240k,nr_inodes=256113,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
tmpfs on /run type tmpfs (rw,nosuid,noexec,relatime,size=206132k,mode=755)
/dev/mapper/vm0-root on / type ext3 (rw,relatime,errors=remount-ro,barrier=1,data=ordered)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)
tmpfs on /run/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=412260k)
/dev/vda1 on /boot type ext2 (rw,relatime,errors=continue)</screen>

      <para>L'option de montage des entrées inutilisées du fichier
      <filename>/etc/fstab</filename> est <option>-a</option>. Elle doit être
      utilisée dans la question suivante.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Comment compléter la configuration système pour assurer le
      montage du nouveau périphérique ?</phrase></para>
      
      <para>Il faut utiliser les réponses aux questions précédentes pour valider
      le nouveau point de montage.</para>
    </question>
    <answer>
    <itemizedlist>
      <listitem>
      <para>Création du point de montage dans l'arborescence du système</para>

<screen width='80'><prompt>#</prompt> mkdir /var/lib/iscsi-target</screen>
      </listitem>
      <listitem>
      <para>Ajout d'une ligne dans le fichier <filename>/etc/fstab</filename>
      avec l'identifiant du périphérique à ajouter</para>

<screen width='80'><prompt>#</prompt> echo UUID=224f6aad-16c0-4923-8949-0628a8e10228 \
  /var/lib/iscsi-target/ \
  ext4 \
  defaults \
  0      2 >>/etc/fstab</screen>
      </listitem>
      <listitem>
      <para>Montage du nouveau périphérique</para>

<screen width='80'><prompt>#</prompt> mount -a</screen>
      </listitem>
      <listitem>
      <para>Nouvelle liste des montages actifs</para>

<screen width='80'><prompt>#</prompt> mount
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
udev on /dev type devtmpfs (rw,relatime,size=10240k,nr_inodes=256113,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
tmpfs on /run type tmpfs (rw,nosuid,noexec,relatime,size=206132k,mode=755)
/dev/mapper/vm0-root on / type ext3 (rw,relatime,errors=remount-ro,barrier=1,data=ordered)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)
tmpfs on /run/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=412260k)
/dev/vda1 on /boot type ext2 (rw,relatime,errors=continue)
<emphasis>/dev/vdb1 on /var/lib/iscsi-target type ext4 (rw,relatime,user_xattr,barrier=1,data=ordered)</emphasis></screen>
      </listitem>
    </itemizedlist>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.initiator'>
  <title>Configuration du système initiator</title>

  <para>Dans cette partie, on prépare le système auquel on a attribué le rôle
  <wordasword>initiator</wordasword>.</para>

  <sect2 xml:id='sysadm-net.iscsi.qa.package'>
    <title>Sélection du paquet et lancement du service</title>

  <qandaset>
    <qandaentry>
    <question>
      <para><phrase>Comment identifier et installer le paquet correspondant au
      rôle <wordasword>initiator</wordasword> ?</phrase></para>

      <para>En effectuant une recherche simple dans le catalogue des paquets
      disponibles, on obtient la liste des paquets dont le nom contient la
      chaîne de caractères <option>iscsi</option>.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> aptitude search iscsi
p   iscsitarget         - iSCSI Enterprise Target userland tools
p   iscsitarget-dkms    - iSCSI Enterprise Target kernel module source - dkms version
p   iscsitarget-source  - iSCSI Enterprise Target kernel module source
p   open-iscsi          - High performance, transport independent iSCSI implementation</screen>
    
      <para>On remarque que le paquet <systemitem>open-iscsi</systemitem> est
      le seul qui ne soit pas identifié comme appartenant à la catégorie
      <wordasword>target</wordasword>.</para>

<screen width='80'><prompt>#</prompt> aptitude install open-iscsi</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Comment lancer le service
      <wordasword>initiator</wordasword> et valider son fonctionnement
      ?</phrase></para>

      <para>À partir de la liste des fichiers du paquet on peut identifier les
      éléments de démarrage et de configuration du service.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> dpkg -L open-iscsi
/.
/etc
/etc/init.d
<emphasis>/etc/init.d/open-iscsi</emphasis>
/etc/init.d/umountiscsi.sh
/etc/network
/etc/network/if-up.d
/etc/default
/etc/default/open-iscsi
/etc/iscsi
<emphasis>/etc/iscsi/iscsid.conf</emphasis>
/etc/iscsi/initiatorname.iscsi
/usr
/usr/share
/usr/share/man
/usr/share/man/man8
/usr/share/man/man8/iscsiadm.8.gz
/usr/share/man/man8/iscsid.8.gz
/usr/share/man/man8/iscsi_discovery.8.gz
/usr/share/man/man8/iscsistart.8.gz
/usr/share/man/man8/iscsi-iname.8.gz
/usr/share/initramfs-tools
/usr/share/initramfs-tools/hooks
/usr/share/initramfs-tools/hooks/iscsi
/usr/share/initramfs-tools/scripts
/usr/share/initramfs-tools/scripts/local-top
/usr/share/initramfs-tools/scripts/local-top/iscsi
/usr/share/doc
/usr/share/doc/open-iscsi
/usr/share/doc/open-iscsi/copyright
/usr/share/doc/open-iscsi/README.Debian.gz
/usr/share/doc/open-iscsi/README.gz
/usr/share/doc/open-iscsi/changelog.Debian.gz
/usr/share/doc/open-iscsi/changelog.gz
/usr/sbin
/usr/sbin/iscsi-iname
/usr/sbin/iscsid
/usr/sbin/iscsi_discovery
/usr/sbin/iscsistart
/usr/bin
<emphasis>/usr/bin/iscsiadm</emphasis>
/var
/var/lib
/var/lib/open-iscsi</screen>

      <para>Le lancement du service se fait de façon classique à partir de
      l'arborescence des scripts des niveaux de démarrage
      (<wordasword>runlevels</wordasword>).</para>

<screen width='80'><prompt>#</prompt> /etc/init.d/open-iscsi restart</screen>

      <para>On peut ensuite consulter les journaux système pour valider
      l'initialisation du ou des démons.</para>

<screen width='80'><prompt>#</prompt> grep -i iscsi /var/log/syslog
Loading iSCSI transport class v2.0-870.
iscsi: registered transport (tcp)
iscsi: registered transport (iser)</screen>

      <para>On retrouve les informations correspondantes aux messages ci-dessus
      dans la liste des processus actifs.</para>

<screen width='80'><prompt>#</prompt> ps aux | grep -i iscsi
root      3479  0.0  0.0      0     0 ?        S&lt;   16:28   0:00 [iscsi_eh]
root      3487  0.0  0.0   4980   472 ?        Ss   16:28   0:00 /usr/sbin/iscsid
root      3488  0.0  0.6   5480  3280 ?        S&lt;Ls 16:28   0:00 /usr/sbin/iscsid</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.tests'>
    <title>Tests de fonctionnement du service</title>

  <qandaset>
    <qandaentry>
    <question>
      <para><phrase>Quelle est la commande principale du rôle
      <wordasword>initiator</wordasword> qui permet de tester la connectivité
      <acronym>iSCSCI</acronym> ?</phrase></para>

      <para>Consulter la liste des fichiers du paquet
      <systemitem>open-iscsi</systemitem>.</para>
    </question>
    <answer>
      <para>En consultant la liste donnée ci-dessus, on ne relève qu'un
      seul outil binaire : la commande <command>iscsiadm</command>.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelles sont les options de découverte proposées avec cette
      commande ? Donner un exemple fournissant l'identifiant de l'unité de
      stockage réseau visible.</phrase></para>

      <para>Consulter les pages de manuels de la commande identifiée dans la
      question précédente.</para>
    </question>
    <answer>
    <para>À partir du poste <wordasword>initator</wordasword> numéro 1, le seul
    volume de stockage visible est :</para>

<screen width='80'><prompt>#</prompt> iscsiadm -m discovery --type sendtargets --portal=198.51.100.2:3260
198.51.100.2:3260,1 iqn.2012-04.lab.stri:1stInitiator.disk</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelles sont les options de connexion proposées avec cette
      même commande ? Donner un exemple illustrant l'établissement d'une
      connexion.</phrase></para>

      <para>Consulter les pages de manuels de la commande identifiée
      précédemment.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> iscsiadm -m node -T iqn.2012-04.lab.stri:1stInitiator.disk -p 198.51.100.2 -l
Logging in to [iface: default, target: iqn.2012-04.lab.stri:1stInitiator.disk, portal: 198.51.100.2,3260] (multiple)
Login to [iface: default, target: iqn.2012-04.lab.stri:1stInitiator.disk, portal: 198.51.100.2,3260] successful.</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Comment obtenir les caractéristiques de l'unité de stockage
      <acronym>iSCSI</acronym> utilisée ?</phrase></para>

      <para>Consulter les journaux système.</para>
    </question>
    <answer>
      <para>Voici un extrait du fichier
      <filename>/var/log/syslog</filename>.</para>

<screen width='80'><prompt>#</prompt> egrep '(sd|scsi)' /var/log/syslog
kernel: [65903.698161] iscsi: registered transport (tcp)
kernel: [65903.707095] iscsi: registered transport (iser)
iscsid: iSCSI logger with pid=3487 started!
iscsid: iSCSI daemon with pid=3488 started!
kernel: [66799.345263] scsi2 : iSCSI Initiator over TCP/IP
kernel: [66799.606328] scsi 2:0:0:0: Direct-Access     IET      VIRTUAL-DISK     0    PQ: 0 ANSI: 4
kernel: [66799.607151] scsi 2:0:0:0: Attached scsi generic sg1 type 0
kernel: [66799.614367] sd 2:0:0:0: [sda] 67108864 512-byte logical blocks: (34.3 GB/32.0 GiB)
kernel: [66799.614998] sd 2:0:0:0: [sda] Write Protect is off
kernel: [66799.615002] sd 2:0:0:0: [sda] Mode Sense: 77 00 00 08
kernel: [66799.616290] sd 2:0:0:0: [sda] Write cache: disabled, read cache: enabled, doesn't support DPO or FUA
kernel: [66799.621310]  sda: unknown partition table
kernel: [66799.623569] sd 2:0:0:0: [sda] Attached SCSI disk
iscsid: Connection1:0 to [target: iqn.2012-04.lab.stri:1stInitiator.disk, portal: 198.51.100.2,3260] through [iface: default] is operational now</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Donner la liste des entrées de périphériques de stockage
      créées par le démon <systemitem>udev</systemitem> ?</phrase></para>

      <para>Lister les entrées de périphériques mode bloc de l'arborescence
      système.</para>
    </question>
    <answer>
      <para>Les fichiers de description des périphériques mode bloc sont tous
      situés dans le répertoire <filename
      class='directory'>/dev/</filename>. En reprenant l'exemple ci-dessus, on
      obtient :</para>

<screen width='80'>ll /dev/[v,s]d*
brw-rw---T 1 root disk   8,  0 sept.  6 16:43 <emphasis>/dev/sda</emphasis>
brw-rw---T 1 root disk 254,  0 sept.  5 22:10 /dev/vda
brw-rw---T 1 root disk 254,  1 sept.  5 22:10 /dev/vda1
brw-rw---T 1 root disk 254,  2 sept.  5 22:10 /dev/vda2
brw-rw---T 1 root disk 254,  5 sept.  5 22:10 /dev/vda5
brw-rw---T 1 root disk 254, 16 sept.  5 22:10 /dev/vdb</screen>

     <para>L'entrée <filename>/dev/sda</filename> correspond à l'unité de
     disque <acronym>iSCSI</acronym>. Le volume de stockage est donc bien vu de
     façon transparente comme un périphérique local au système accessible en
     mode bloc. Il entre bien dans la catégorie <acronym>SAN</acronym> ou
     <wordasword>Storage Area Network</wordasword>.</para>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.automatic'>
    <title>Configuration système</title>

  <para>Une fois la connexion à la ressource <acronym>iSCSI</acronym> testée,
  on peut passer à la configuration système de façon à retrouver le volume de
  stockage après une réinitialisation du système
  <wordasword>initiator</wordasword>.</para>

  <qandaset>
    <qandaentry>
    <question>
    <para><phrase>Comment rendre la connexion à l'unité de stockage automatique
    lors de l'initialisation du système <wordasword>initiator</wordasword>
    ?</phrase></para>

    <para>Rechercher dans la liste des fichiers du paquet
    <application>open-iscsi</application> les éléments relatifs à la
    configuration système. Éditer le fichier de configuration principal de
    façon à rendre automatique le lancement du service.</para>
    </question>
    <answer>
    <para>Au niveau système, les fichiers de configuration sont nécessairement
    dans le répertoire <filename class='directory'>/etc/</filename>.</para>

<screen width='80'><prompt>#</prompt> dpkg -L open-iscsi | grep '/etc/'
/etc/default
/etc/default/open-iscsi
/etc/init.d
/etc/init.d/open-iscsi
/etc/init.d/umountiscsi.sh
/etc/iscsi
<emphasis>/etc/iscsi/iscsid.conf</emphasis>
/etc/iscsi/initiatorname.iscsi
/etc/network
/etc/network/if-up.d</screen>

    <para>Le fichier <filename>/etc/iscsi/iscsid.conf</filename> contient une
    directive dans la section <wordasword>Startup settings</wordasword> qui
    rend automatique l'accès à une ressource déjà enregistrée. Voici le contenu
    de cette section extraite du fichier de configuration.</para>

<screen width='80'>#*****************
# Startup settings
#*****************

# To request that the iscsi initd scripts startup a session set to "automatic".
<emphasis>node.startup = automatic</emphasis></screen>
    </answer>
    </qandaentry>

    <qandaentry xml:id='sysadm-net.iscsi.qa.auth'>
    <question>
    <para><phrase>Comment authentifier la connexion entre les systèmes
    <wordasword>initiator</wordasword> et <wordasword>target</wordasword>
    ?</phrase></para>

    <para>Rechercher dans les fichiers de configuration identifiés auparavant
    les paramètres relatifs à l'authentification. Pour atteindre un meilleur
    niveau de sécurité, on souhaite mettre en place une authentification
    mutuelle des deux extrémités en communication.</para>
    </question>
    <answer>
    <para>Le mécanisme d'authentification le plus communément utilisé dans le
    déploiement des connexions <acronym>iSCSI</acronym> s'appuie sur
    <acronym>CHAP</acronym> (<wordasword>Challenge-Handshake Authentication
    Protocol</wordasword>). Il s'agit d'une méthode d'authentification entre
    deux hôtes pairs sans échange de mot de passe en clair sur le réseau. Cette
    méthode suppose que les deux hôtes utilisent le même mot de passe.</para>

    <para>Le nom d'utilisateur et le mot de passe sont respectivement définis
    dans les fichiers <filename>/etc/ietd.conf</filename> et
    <filename>/etc/iscsi/iscsid.conf</filename> des systèmes
    <wordasword>target</wordasword> et
    <wordasword>initiator</wordasword>.</para>

    <itemizedlist>
      <listitem>
      <para>Système <wordasword>target</wordasword> :</para>

<screen width='80'>
Target iqn.2012-04.lab.stri:1stInitiator.disk
        Lun 0 Path=/var/lib/iscsi-target/1stInitiator.disk,Type=fileio
        Alias 1stInitiator.disk
        IncomingUser SAN-lab-1stInitiator MyS4N-1stInitiator-53cr3t
        OutgoingUser SAN-lab-1stTarget MyS4N-1stTarget-53cr3t
#
Target iqn.2012-04.lab.stri:2ndInitiator.disk
        Lun 1 Path=/var/lib/iscsi-target/2ndInitiator.disk,Type=fileio
        Alias 2ndInitiator.disk
        IncomingUser SAN-lab-2ndInitiator MyS4N-2ndInitiator-53cr3t
        OutgoingUser SAN-lab-2ndTarget MyS4N-2ndTarget-53cr3t
&lt;snipped/></screen>
      </listitem>
      <listitem>
      <para>Système <wordasword>initiator</wordasword> :</para>

<screen width='80'># *************
# CHAP Settings
# *************

# To enable CHAP authentication set node.session.auth.authmethod
# to CHAP. The default is None.
node.session.auth.authmethod = CHAP

# To set a CHAP username and password for initiator
# authentication by the target(s), uncomment the following lines:
node.session.auth.username = SAN-lab-1stInitiator
node.session.auth.password = MyS4N-1stInitiator-53cr3t

# To set a CHAP username and password for target(s)
# authentication by the initiator, uncomment the following lines:
node.session.auth.username_in = SAN-lab-1stTarget
node.session.auth.password_in = MyS4N-1stTarget-53cr3t</screen>

      <para>Le même principe peut être appliqué au mécanisme de découverte en
      appliquant un couple <wordasword>login/password</wordasword> identique ou
      non à la suite de ce fichier de configuration.</para>
      </listitem>
    </itemizedlist>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.target'>
  <title>Configuration du système target</title>

  <para>Dans cette partie, on prépare le système auquel on a attribué le rôle
  <wordasword>target</wordasword>. Cette préparation comprend deux
  étapes : la construction et l'installation d'un paquet contenant le
  module de la partie <wordasword>KernelSpace</wordasword> du service et la
  configuration des outils de la partie <wordasword>UserSpace</wordasword> pour
  lancer le démon <systemitem class='daemon'>ietd</systemitem>.</para>

  <sect2 xml:id='sysadm-net.iscsi.qa.target.build'>
    <title>Sélection des paquets et compilation du module</title>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para><phrase>Quels sont les paquets de la distribution Debian GNU/Linux
      qui permettent de configurer un système avec le rôle
      <wordasword>target</wordasword> ?</phrase></para>

      <para>En effectuant une recherche simple dans le catalogue des paquets
      disponibles, on obtient la liste des paquets dont le nom contient la
      chaîne de caractères <option>iscsi</option>.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> aptitude search iscsi
p   iscsitarget       - iSCSI Enterprise Target userland tools
p   iscsitarget-dkms  - iSCSI Enterprise Target kernel module source - dkms version
p   libiscsi-bin      - iSCSI client shared library - utilities
p   libiscsi-dev      - iSCSI client shared library
p   libiscsi1         - iSCSI client shared library
p   open-iscsi        - High performance, transport independent iSCSI implementation</screen>
    
    <para>Dans la liste ci-dessus, on distingue deux éléments. Le premier
    paquet : <systemitem>iscsitarget-dkms</systemitem> contient le code source
    du module qui doit être chargé en mémoire pour faire fonctionner le
    service. Ce module doit être compilé en fonction de la version du noyau
    actif sur le système. La version <acronym>DKMS</acronym> associée à la
    gestion des dépendances permet de construire automatiquement un paquet
    correspodant à la version du noyau Linux utilisée. Le second paquet :
    <systemitem>iscsitarget</systemitem> contient le logiciel de gestion du
    service.</para>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est la commande d'installation des paquets
      nécessaires à la compilation des modules et à la configuration du rôle
      <wordasword>target</wordasword> ?</phrase></para>

      <para>utiliser le gestionnaire de paquets pour installer les paquets
      retenus dans la question précédente.</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> aptitude install iscsitarget iscsitarget-dkms
Les NOUVEAUX paquets suivants vont être installés : 
  binutils{a} cpp{a} cpp-4.6{a} cpp-4.7{a} dkms{a} fakeroot{a} gcc{a}
  gcc-4.6{a} gcc-4.6-base{a} gcc-4.7{a} iscsitarget iscsitarget-dkms
  libc-dev-bin{a} libc6-dev{a} libgmp10{a} libgomp1{a} libitm1{a} libmpc2{a}
  libmpfr4{a} libquadmath0{a} linux-headers-3.2.0-3-amd64{a}
  linux-headers-3.2.0-3-common{a} linux-headers-amd64{a} linux-kbuild-3.2{a}
  linux-libc-dev{a} make{a} manpages-dev{a} menu{a} 
0 paquets mis à jour, 28 nouvellement installés, 0 à enlever et 0 non mis à jour.
Il est nécessaire de télécharger 42,7 Mo d'archives. Après dépaquetage, 124 Mo seront utilisés.
Voulez-vous continuer ? [Y/n/?]
&lt;snipped/>
</screen>

    <para>On retrouve le module compilé à l'aide du service
    <acronym>DKMS</acronym> dans l'arborescence usuelle des modules du noyau
    Linux.</para>

<screen width='80'><prompt>#</prompt> ll /lib/modules/`uname -r`/updates/dkms
total 132K
-rw-r--r-- 1 root root 128K sept.  5 22:20 iscsi_trgt.ko</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.target.config'>
    <title>Configuration du service</title>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para><phrase>Quel est le paquet qui contient les éléments de
      configuration du service dans l'espace utilisateur ?</phrase></para>

      <para>On reprend la liste des paquets <acronym>iSCSI</acronym>
      installés pour identifier celui qui contient le démon du service.</para>
    </question>
    <answer>

<screen width='80'><prompt>#</prompt> aptitude search ~iiscsi
i   iscsitarget        - iSCSI Enterprise Target userland tools
i   iscsitarget-dkms   - iSCSI Enterprise Target kernel module source - dkms version</screen>

      <para>Une fois le paquet identifié, on peut lister son contenu.</para>

<screen width='80'><prompt>#</prompt> dpkg -L iscsitarget
/.
/etc
/etc/init.d
/etc/init.d/iscsitarget
/etc/default
<emphasis>/etc/default/iscsitarget</emphasis>
/etc/sysctl.d
/etc/sysctl.d/30-iscsitarget.conf
/etc/iet
<emphasis>/etc/iet/ietd.conf</emphasis>
/etc/iet/targets.allow
/etc/iet/initiators.allow
/usr
/usr/share
/usr/share/man
/usr/share/man/man5
/usr/share/man/man5/ietd.conf.5.gz
/usr/share/man/man8
/usr/share/man/man8/ietd.8.gz
/usr/share/man/man8/ietadm.8.gz
/usr/share/lintian
/usr/share/lintian/overrides
/usr/share/lintian/overrides/iscsitarget
/usr/share/doc
/usr/share/doc/iscsitarget
/usr/share/doc/iscsitarget/ChangeLog.gz
/usr/share/doc/iscsitarget/copyright
/usr/share/doc/iscsitarget/README.Debian
/usr/share/doc/iscsitarget/README.vmware
/usr/share/doc/iscsitarget/README.gz
/usr/share/doc/iscsitarget/changelog.Debian.gz
/usr/share/doc/iscsitarget/changelog.gz
/usr/share/doc/iscsitarget/NEWS.Debian.gz
/usr/sbin
/usr/sbin/ietadm
<emphasis>/usr/sbin/ietd</emphasis></screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quelle est l'opération à effectuer pour lancer
      automatiquement le service lors de l'initialisation du système
      ?</phrase></para>

      <para>Le répertoire <filename class='directory'>/etc/default</filename>
      contient une liste de fichiers de contrôle qui servent à paramétrer les
      services lors de leur démarrage.</para>
    </question>
    <answer>
      <para>Dans la liste donnée dans la question ci-dessus, on relève le
      fichier <filename>/etc/default/iscsitarget</filename> dont le contenu
      est à éditer pour activer le service.</para>

<screen width='80'><prompt>#</prompt> cat /etc/default/iscsitarget
ISCSITARGET_ENABLE=true</screen>
    </answer>
    </qandaentry>

    <qandaentry>
    <question>
      <para><phrase>Quel est le fichier de configuration principal du service ?
      Quelles sont les entrées utiles au fonctionnement du rôle
      <wordasword>target</wordasword> ?</phrase></para>

      <para>Toujours à partir de la liste des fichiers du paquets, on recherche
      les fichiers appartenant au répertoire <filename
      class='directory'>/etc/</filename> pour identifier celui qui sert à
      configurer le démon.</para>
    </question>
    <answer>
      <para>Ici, on repère facilement le fichier
      <filename>/etc/iet/ietd.conf</filename> que l'on doit éditer pour donner
      accès à l'unité de stockage réseau.</para>

      <para>Parmi les multiples choix disponibles pour la désignation des
      unités de stockage que l'on souhaite rendre accessible via le réseau, on
      peut retenir deux solutions classiques. Pour ces deux solutions on donne
      un exemple de fichier de configuration.</para>

      <itemizedlist>
        <listitem>
	<para>On peut désigner une unité physique locale en mode bloc
	(<acronym>DAS</acronym>) comme ressource cible
	<acronym>iSCSI</acronym>.</para>

<screen width='80'><prompt>#</prompt> egrep -v '(^*#|^$)' /etc/iet/ietd.conf
Target iqn.2012-09.lab.stri:san.disk
        Lun 0 Path=<emphasis>/dev/vdb,Type=blockio</emphasis>
	Alias san.disk</screen>
	</listitem>
	<listitem>
	<para>On peut désigner un fichier local comme ressource cible
	<acronym>iSCSI</acronym>. Cette seconde option est intéressante pour
	fournir plusieurs unités logiques (<acronym>LUN</acronym>) à partir
	d'un même volume local (<acronym>DAS</acronym>).</para>

<screen width='80'><prompt>#</prompt> egrep -v '(^*#|^$)' /etc/iet/ietd.conf 
Target iqn.2012-04.lab.stri:1stInitiator.disk
        Lun 0 Path=<emphasis>/var/lib/iscsi-target/1stInitiator.disk,Type=fileio</emphasis>
        Alias 1stInitiator.disk
Target iqn.2012-04.lab.stri:2ndInitiator.disk
        Lun 1 Path=<emphasis>/var/lib/iscsi-target/2ndInitiator.disk,Type=fileio</emphasis>
        Alias 2ndInitiator.disk</screen>
	</listitem>
      </itemizedlist>

      <para>Deux remarques sur les choix de configuration :</para>

      <itemizedlist>
        <listitem>
	  <para>La technologie <acronym>iSCSI</acronym> dispose d'un schéma de
	  nommage propre défini dans le document standard <link
	  xmlns="http://docbook.org/ns/docbook" xlink:href='http://www.ietf.org/rfc/rfc3721.txt'>RFC3721</link>. Le format
	  retenu ici est baptisé <acronym>iqn</acronym> (<wordasword>iSCSI
	  Qualified Name</wordasword>). Il s'agit d’une chaîne qui débute par
	  "iqn." suivie d’une date au format AAAA-MM, du nom de l’autorité qui
	  a attribué le nom (le nom de domaine à l’envers), puis une autre
	  chaîne unique qui identifie le nœud de stockage.</para>
	</listitem>
	<listitem>
	  <para>On a choisi de n'utiliser aucun mécanisme d'authentification
	  sachant que la configuration se fait dans un contexte de travaux
	  pratiques et non d'exploitation sur un réseau réel.</para>
	</listitem>
      </itemizedlist>
    </answer>
    </qandaentry>

    <qandaentry>
      <question>
	<para><phrase>Comment lancer le service et s'assurer de son bon
	fonctionnement ?</phrase></para>

	<para>Retrouver le script de lancement du service dans l'arborescence
	des <wordasword>runlevels</wordasword>. Relever ensuite les traces du
	lancement du service dans les journaux système, dans la liste des
	processus en cours d'exécution et dans la liste des ports réseau en
	écoute.</para>
      </question>
      <answer>
	<para>Les scripts de manipulation des services sont dans le répertoire
	<filename class='directory'>/etc/init.d/</filename>.</para>

<screen width='80'><prompt>#</prompt> /etc/init.d/iscsitarget restart</screen>

	<para>Ensuite, pour le contrôle de l'état du service, on passe par les
	étapes classiques.</para>

	<itemizedlist>
	  <listitem>
	    <para>Consultation des journaux système.</para>

<screen width='80'><prompt>#</prompt> grep -i iscsi /var/log/syslog
iSCSI Enterprise Target Software - version 1.4.20.3
iscsi_trgt: Registered io type fileio
iscsi_trgt: Registered io type blockio
iscsi_trgt: Registered io type nullio
Registered io type nullio</screen>
	  </listitem>
	  <listitem>
	    <para>Recherche dans la liste des processus actifs.</para>

<screen width='80'><prompt>#</prompt> ps aux | grep iet
root     10881  0.0  0.0   4128   576 ?        Ss   16:18   0:00 /usr/sbin/ietd</screen>
	  </listitem>
	  <listitem>
	    <para>Comme il s'agit d'un service réseau, on peut identifier les
	    ports ouverts correspondant au démon.</para>

<screen width='80'><prompt>#</prompt> lsof -i | grep ietd
ietd    10881       root    7u  IPv4  15851      0t0  TCP *:iscsi-target (LISTEN)
ietd    10881       root    8u  IPv6  15852      0t0  TCP *:iscsi-target (LISTEN)</screen>
	  </listitem>
	</itemizedlist>
      </answer>
    </qandaentry>

    <qandaentry>
      <question>
	<para><phrase>Comment autoriser l'accès réseau aux volumes de stockage
	uniquement à partir des clients désignés ?</phrase></para>

	<para>Repérer le fichier dédié aux autorisations dans la liste des
	fichiers de configuration du paquet des outils de l'espace
	utilisateur.</para>
      </question>
      <answer>
	<para>On utilise le fichier <filename>/etc/initiators.allow</filename>
	pour configurer les accès réseau. Dans l'exemple ci-dessous, le poste
	dispose de deux volumes mis à dispostion de deux clients distincts. On
	utilise ici les adresses <acronym>IP</acronym> de chacun des
	clients.</para>

<screen width='80'><prompt>#</prompt> egrep -v ^# /etc/iet/initiators.allow
iqn.2012-04.lab.stri:1stInitiator.disk 198.51.100.3
iqn.2012-04.lab.stri:2ndInitiator.disk 198.51.100.4</screen>
      </answer>
    </qandaentry>

    <qandaentry>
    <question>
    <para><phrase>Comment authentifier la connexion entre les systèmes
    <wordasword>initiator</wordasword> et <wordasword>target</wordasword>
    ?</phrase></para>

    <para>Pour traiter cette question, il faut faire correspondre les
    configurations à partir de la <link linkend='sysadm-net.iscsi.qa.auth'>même
    question</link> posée dans la section sur le rôle
    <wordasword>initiator</wordasword>.</para>
    </question>
    </qandaentry>

    <qandaentry>
      <question>
	<para><phrase>Comment visualiser l'état de la session d'accès à la
	ressource de stockage <acronym>iSCSI</acronym> ?</phrase></para>

	<para>Rechercher dans le système de fichiers virtuel <filename
	class='directory'>/proc/</filename> les informations de suivi de
	session.</para>
      </question>
      <answer>
	<para>Le fichier <filename>/proc/net/iet/session</filename>
	donne l'état courant de la session avec l'adresse IP du système
	<acronym>initiator</acronym>.</para>

	<para>Dans le premier extrait ci-dessous, aucune session n'a été
	établie. Dans le second, une session est établie depuis le client ayant
	l'adresse <acronym>IP</acronym> <systemitem
	class='ipaddress'>198.51.100.3</systemitem>.</para>

<screen width='80'><prompt>#</prompt> cat /proc/net/iet/session 
tid:2 name:iqn.2012-04.lab.stri:2ndInitiator.disk
tid:1 name:iqn.2012-04.lab.stri:1stInitiator.disk</screen>

<screen width='80'><prompt>#</prompt> cat /proc/net/iet/session 
tid:2 name:iqn.2012-04.lab.stri:2ndInitiator.disk
tid:1 name:iqn.2012-04.lab.stri:1stInitiator.disk
        sid:281474997486080 initiator:
                cid:0 ip:198.51.100.3 state:active hd:none dd:none</screen>
      </answer>
    </qandaentry>
  </qandaset>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.raid1'>
  <title>Configuration d'une unité logique RAID1</title>

  <para>Dans cette partie, on crée une unité logique <acronym>RAID1</acronym>
  composée d'une unité de disque locale et d'une unité de disque
  <acronym>iSCSI</acronym> dans le but d'illustrer une solution de réplication
  synchrone. En effet, dans un volume <acronym>RAID1</acronym> chaque disque
  contient à tout moment exactement les mêmes données. Ici, le contenu de
  l'unité de disque locale est identique à celui de l'unité de disque réseau.
  La réplication ainsi réalisée est dite synchrone puisque toute écriture
  locale est dupliquée sur le réseau de stockage
  <acronym>iSCSI</acronym>.</para>

  <sect2 xml:id='sysadm-net.iscsi.qa.raid1.config'>
    <title>Sélection du paquet et création de l'unité de stockage</title>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para>Quel est le paquet qui contient les outils de configuration et de
      gestion des différents types d'unités <acronym>RAID</acronym> logicielles
      ?</para>
    </question>
    <answer>
      <para>On utilise à nouveau les recherches dans les listes de paquets de
      la distribution.</para>

<screen width='80'><prompt>#</prompt> apt-cache search software raid
&lt;snipped/>
mdadm - tool to administer Linux MD arrays (software RAID)
&lt;snipped/></screen>

      <para>Une fois le paquet identifié et installé, on peut lister son
      contenu et isoler les commandes utilisateur.</para>

<screen width='80'><prompt>#</prompt> dpkg -L mdadm | grep bin
/sbin
/sbin/mdmon
/sbin/mdadm-startall
/sbin/mdadm</screen>
      </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para>Quelle est la syntaxe de la commande <command>mdadm</command> qui
      permet de créer l'unité logique <acronym>RAID1</acronym> ?</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> mdadm --create /dev/md0 --level=raid1 --raid-devices=2 /dev/sda /dev/vdb
mdadm: partition table exists on /dev/sda but will be lost or
       meaningless after creating array
mdadm: Note: this array has metadata at the start and
    may not be suitable as a boot device.  If you plan to
    store '/boot' on this device please ensure that
    your boot-loader understands md/v1.x metadata, or use
    --metadata=0.90
Continue creating array? y
mdadm: Defaulting to version 1.2 metadata
mdadm: array /dev/md0 started.</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.raid1.manage'>
    <title>Manipulations sur l'unité de stockage RAID1</title>

  <qandaset defaultlabel='number'>
    <qandaentry>
    <question>
      <para>Comment connaître l'état de l'unité logique <acronym>RAID1</acronym> ?</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> cat /proc/mdstat</screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para>Comment afficher la liste des propriétés de l'unité logique <acronym>RAID1</acronym> ?</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> mdadm --detail /dev/md0</screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para>Comment rendre la configuration système permanente ?</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> mdadm --detail --scan >> /etc/mdadm/mdadm.conf</screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para>Comment rendre la configuration système permanente ?</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> mdadm --detail --scan >> /etc/mdadm/mdadm.conf</screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para>Comment arrêter le gestionnaire <acronym>RAID</acronym> ?</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> mdadm --stop /dev/md0</screen>
    </answer>
    </qandaentry>
    <qandaentry>
    <question>
      <para>Comment retirer une unité du gestionnaire <acronym>RAID</acronym> ?</para>
    </question>
    <answer>
<screen width='80'><prompt>#</prompt> mdadm /dev/md0 --fail /dev/sda --remove /dev/sda</screen>
    </answer>
    </qandaentry>
  </qandaset>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.vm'>
  <title>Manipulations sur machines virtuelles</title>

  <para>Il est possible de réaliser l'ensemble des manipulations de ce support
  à l'aide de trois instances de machines virtuelles et du commutateur virtuel
  <citetitle>Virtual Distributed Ethernet</citetitle> présenté dans l'article
  &url.vm;</para>

  <sect2 xml:id='sysadm-net.iscsi.qa.vm.host'>
    <title>Préparation du système hôte</title>

  <para>L'infrastructure à implanter sur le système hôte est la
  suivante.</para>

  <mediaobject>
    <imageobject>
    <imagedata fileref='images/topologie-iscsi-vm.png' format='PNG' contentwidth='15cm' width='15.5cm'/>
    </imageobject>
    <textobject>
    <phrase>Topologie virtualisation iSCSI</phrase>
    </textobject>
    <caption>
    <para><link xmlns="http://docbook.org/ns/docbook" xlink:href='http://www.linux-france.org/prj/inetdoc/cours/sysadm-net.iscsi.qa/images/topologie-iscsi-vm.png'>
    Topologie virtualisation iSCSI - vue complète</link></para>
    </caption>
  </mediaobject>

  <para>On débute avec la création des fichiers image des trois systèmes
  virtuels. Les fichiers de type <filename>.qcow2</filename> sont des images
  compressées et sont plus faciles à transférer que les fichiers de type
  <filename>.raw</filename>.</para>

<screen width='80'>mkdir -p ~/vm/iscsi
cd ~/vm/iscsi

cp ../vm0-debian-testing-amd64-base.qcow2 targetSrv.qcow2
cp ../vm0-debian-testing-amd64-base.qcow2 1stInitiator.qcow2
cp ../vm0-debian-testing-amd64-base.qcow2 2ndInitiator.qcow2

for file in *.qcow2; do qemu-img convert -f qcow2 -O raw $file `basename $file .qcow2`.raw; done

rm *.qcow2</screen>

  <para>On crée ensuite les fichiers correspondant aux unités de stockage
  supplémentaires.</para>

<screen width='80'>qemu-img create -f raw targetSrv-disk.raw 80G
qemu-img create -f raw 1stInitiator-disk.raw 32G
qemu-img create -f raw 2ndInitiator-disk.raw 32G</screen>

  <para>Enfin, il ne reste qu'à mettre en place le script de lancement de ces
  trois systèmes avec leurs unités de stockages respectives.</para>

<screen width='80'>#!/bin/bash

../scripts/startup.sh targetSrv.raw 512 2 \
    -drive file=targetSrv-disk.raw,if=virtio,boot=off

../scripts/startup.sh 1stInitiator.raw 512 3 \
    -drive file=1stInitiator-disk.raw,if=virtio,boot=off 

../scripts/startup.sh 2ndInitiator.raw 512 4 \
    -drive file=2ndInitiator-disk.raw,if=virtio,boot=off</screen>

  <para>Ce script fait lui-même appel au script commun
  <filename>startup.sh</filename> qui sert à initialiser une instance de
  machine virtuelle en utilisant comme paramètres le nom du fichier image, la
  quantité de <acronym>RAM</acronym> et le port du commutateur
  <acronym>VDE</acronym>. Le &url.vm.startup.sh; est donné en annexe de
  l'article &url.vm;.</para>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.vm.targetSrv'>
    <title>Serveur target iSCSI</title>

  <para>Cette instance de système virtuel joue le rôle du système
  <wordasword>target</wordasword> <acronym>iSCSI</acronym>. On reprend donc ici
  les manipulations présentées dans la <xref
  linkend='sysadm-net.iscsi.qa.target'/> après avoir préparé le volume de
  stockage et les fichiers ressource cible <acronym>iSCSI</acronym>.</para>

  <para>Lors de l'initialisation des trois systèmes virtuels, on a ajouté un
  fichier disque de 80Go à l'instance baptisée
  <systemitem>targetSrv</systemitem>. C'est ce volume de stockage qui est
  utilisé pour ouvrir l'accès aux deux unités ressources cible
  <acronym>iSCSI</acronym>.</para>

  <para>On reprend les manipulations de la <xref
  linkend='sysadm-net.iscsi.qa.storage'/> pour le partitionnement et le
  formatage du volume physique virtuel repéré
  <filename>/dev/vdb</filename>.</para>

<screen width='80'>dd if=/dev/zero of=/dev/vdb bs=512 count=4

parted /dev/vdb mklabel gpt
parted /dev/vdb mkpart primary ext4 1 -1

mkfs.ext4 /dev/vdb1

mkdir /var/lib/target

mount /dev/vdb1 /var/lib/target</screen>

  <para>Pour rendre ce montage «permanent», on édite le fichier
  <filename>/etc/fstab</filename> après avoir identifié le volume de
  stockage.</para>

<screen width='80'>blkid | grep vdb
/dev/vdb1: UUID="10f56553-ca7c-4827-b43f-8ef664fcef6f" TYPE="ext4"

echo UUID="10f56553-ca7c-4827-b43f-8ef664fcef6f" \
  /var/lib/target/ \
  ext4 \
  defaults \
  0      2 >>/etc/fstab</screen>

  <para>Une fois le montage du volume effectué à partir du répertoire <filename
  class='directory'>/var/lib/target</filename>, on peut créer les fichiers
  ressources cible <acronym>iSCSI</acronym> à l'aide de la commande
  <command>dd</command>. On crée des fichier de type &url.sparse_file; pour
  optimiser l'occupation disque réelle sur le système hôte.</para>

  <para>Pour respecter le scénario des travaux pratiques, on utilise des
  fichiers de 32Go composés de blocs de 4Ko qui correspondent au volumes de
  stockage des deux autres instances de machines virtuelles. La «formule de
  calcul» devient : <literal>(32 x 1024 x 1024 x 1024) / (4 x 1024) =
  8388608</literal>.</para>

<screen width='80'><prompt>#</prompt> mkdir /var/lib/iscsi-target
<prompt>#</prompt> cd /var/lib/iscsi-target/
<prompt>#</prompt> dd if=/dev/null of=1stInitiator.disk bs=4k seek=8388608
0+0 enregistrements lus
0+0 enregistrements écrits
0 octet (0 B) copié, 1,3982e-05 s, 0,0 kB/s
<prompt>#</prompt> dd if=/dev/null of=2ndInitiator.disk bs=4k seek=8388608
0+0 enregistrements lus
0+0 enregistrements écrits
0 octet (0 B) copié, 1,217e-05 s, 0,0 kB/s
<prompt>#</prompt> ls -lAh
total 0
-rw-r--r-- 1 root root 32G sept.  5 22:38 1stInitiator.disk
-rw-r--r-- 1 root root 32G sept.  5 22:38 2ndInitiator.disk
<prompt>#</prompt> du -hs *.disk
0       1stInitiator.disk
0       2ndInitiator.disk</screen>

  <para>Comme indiqué dans la <xref linkend='sysadm-net.iscsi.qa.target'/>, on
  installe les paquets <systemitem>iscsitarget</systemitem> et
  <systemitem>iscsitarget-dkms</systemitem>. Le fichier de configuration du
  démon <systemitem class='daemon'>ietd</systemitem> contient les références
  aux deux fichiers ci-dessus.</para>

<screen width='80'>egrep -v '(^*#|^$)' /etc/iet/ietd.conf 
Target iqn.2011-04.lab.stri:1stInitiator.disk
        Lun 0 Path=/var/lib/target/1stInitiator.disk,Type=fileio
        Alias 1stInitiator.disk
Target iqn.2011-04.lab.stri:2ndInitiator.disk
        Lun 1 Path=/var/lib/target/2ndInitiator.disk,Type=fileio
        Alias 2ndInitiator.disk</screen>

  <para>Une fois le service démarré, ces deux ressources cibles
  <acronym>iSCSI</acronym> sont utilisables.</para>

<screen width='80'>cat /proc/net/iet/session
tid:2 name:iqn.2011-04.lab.stri:2ndInitiator.disk
tid:1 name:iqn.2011-04.lab.stri:1stInitiator.disk</screen>
  </sect2>

  <sect2 xml:id='sysadm-net.iscsi.qa.vm.initiator'>
    <title>Clients initiator iSCSI</title>

  <para>Ces deux instances de système virtuel jouent le rôle du système
  <wordasword>initiator</wordasword> <acronym>iSCSI</acronym>. On reprend donc
  ici les manipulations présentées dans la <xref
  linkend='sysadm-net.iscsi.qa.initiator'/> avant de passer à la configuration
  de l'unité logique <acronym>RAID1</acronym>.</para>
  </sect2>
</sect1>

<sect1 xml:id='sysadm-net.iscsi.qa.refdocs'>
  <title>Documents de référence</title>

  <variablelist>
    <varlistentry xml:id='sysadm-net.iscsi.qa.infra.tp'>
    <term><citetitle>Architecture réseau des travaux pratiques</citetitle></term>
    <listitem>
      <para>&url.infra.tp; : présentation de l'implantation des
      équipements d'interconnexion réseau dans l'armoire de brassage et du plan
      d'adressage <acronym>IP</acronym> prédéfini pour l'ensemble des séances
      de travaux pratiques. Ce document est utilisé dans la <xref
      linkend='sysadm-net.iscsi.qa.affectation'/>.</para>
    </listitem>
    </varlistentry>

    <varlistentry xml:id='sysadm-net.iscsi.qa.config.interface.lan'>
      <term><citetitle>Configuration d'une interface réseau</citetitle></term>
      <listitem>
        <para>&url.config.interface.lan; : tout sur la configuration des
	interfaces réseau de réseau local. Comme dans le cas précédent, ce
	document est utile pour effectuer les opérations demandées dans la
	<xref linkend='sysadm-net.iscsi.qa.affectation'/>.</para>
      </listitem>
    </varlistentry>
    
    <varlistentry xml:id='sysadm-net.iscsi.qa.introduction'>
    <term><citetitle>Introduction to iSCSI</citetitle></term>
    <listitem>
      <para>L'article intitulé &url.iscsi.linux-mag.introduction; du site Linux
      Magazine présente les points clés de la technologie
      <acronym>iSCSI</acronym>. Il complète la <xref
      linkend='sysadm-net.iscsi.qa.topology'/>.</para>
    </listitem>
    </varlistentry>

    <varlistentry xml:id='sysadm-net.iscsi.qa.unixgarden'>
    <term><citetitle>Le support du protocole iSCSI dans Linux</citetitle></term>
    <listitem>
      <para>L'article &url.iscsi.unixgarden; de la rubrique «Administration
      Réseau» du site <citetitle>Unix Garden</citetitle> présente l'ensemble
      des manipulations effectuées dans ce support de travaux pratiques. C'est
      une référence indispensable.</para>
    </listitem>
    </varlistentry>

    <varlistentry xml:id='sysadm-net.iscsi.qa.debian.wiki'>
    <term><citetitle>iSCSI - Debian Wiki</citetitle></term>
    <listitem>
      <para>La page &url.iscsi.debian.wiki; contient deux sous-rubriques sur
      les rôles <wordasword>initiator</wordasword> et
      <wordasword>target</wordasword>. Ces sous-rubriques correspondent
      respectivement à la <xref linkend='sysadm-net.iscsi.qa.initiator'/> et à
      la <xref linkend='sysadm-net.iscsi.qa.target'/>. On y retrouve les paquets
      à utiliser et les principales commandes de configuration.</para>
    </listitem>
    </varlistentry>
  </variablelist>
</sect1>
</article>
